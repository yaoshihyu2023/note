<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>pine-script - Jason Notes</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/custom/custom.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html">Jason Notes</a></li><li class="chapter-item expanded "><a href="../ubuntu/ubuntu_setup.html">Ubuntu</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../ubuntu/command.html">Command</a></li><li class="chapter-item "><a href="../ubuntu/gcp.html">GCP ssh</a></li></ol></li><li class="chapter-item expanded "><a href="../android/android.html">Android</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../android/install_sdk.html">SDK install</a></li></ol></li><li class="chapter-item expanded "><a href="../tools/tools.html">Tools</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../tools/asciinema.html">asciinema 把終端操作錄製成 gif 動畫</a></li><li class="chapter-item "><a href="../tools/finmind.html">Finmind</a></li><li class="chapter-item "><a href="../tools/add-enter-and-exit-trace-for-your-function.html">addr2line</a></li><li class="chapter-item "><a href="../tools/cmake.html">cmake</a></li><li class="chapter-item "><a href="../tools/network.html">Network</a></li><li class="chapter-item "><a href="../tools/python-pycryptodome-aes-symmetric-encryption-tutorial-examples.html">實作 AES 對稱式加密</a></li></ol></li><li class="chapter-item expanded "><a href="../html/html.html">HTML</a></li><li class="chapter-item expanded "><a href="../vim/vim.html">Vim</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../vim/copilot.html">copilot</a></li><li class="chapter-item "><a href="../vim/tabnine.html">tabnine</a></li></ol></li><li class="chapter-item expanded "><a href="../gdb/gdb.html">Gdb</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../gdb/常用指令.html">常用指令</a></li><li class="chapter-item "><a href="../gdb/jemalloc.html">jemalloc</a></li><li class="chapter-item "><a href="../gdb/graphs.html">graphs</a></li><li class="chapter-item "><a href="../gdb/rust-gdb.html">rust gdb</a></li></ol></li><li class="chapter-item expanded "><a href="../c++/cpp.html">C++</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../c++/benchmark.html">benchmark</a></li><li class="chapter-item "><a href="../c++/smart_pointer.html">Smart pointer</a></li><li class="chapter-item "><a href="../c++/l&rvalue.html">L&amp;R value</a></li><li class="chapter-item "><a href="../c++/move.html">Move</a></li><li class="chapter-item "><a href="../c++/CAS.html">CAS</a></li><li class="chapter-item "><a href="../c++/HFT.html">HFT</a></li></ol></li><li class="chapter-item expanded "><a href="../riscv/riscv.html">RISC-V</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../riscv/qemu_riscv_linux.html">QEMU上運行RISV-V Linux</a></li></ol></li><li class="chapter-item expanded "><a href="../centos/centos.html">CentOS</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../centos/tqdb_setup.html">TQDB 安裝紀錄</a></li></ol></li><li class="chapter-item expanded "><a href="../ssh/ssh.html">SSH</a></li><li class="chapter-item expanded "><a href="../network/socket.html">Network</a></li><li class="chapter-item expanded "><a href="../docker/docker_helloworld.html">Docker</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../docker/docker.html">Docker 基本教學</a></li><li class="chapter-item "><a href="../docker/example.html">簡單範例</a></li><li class="chapter-item "><a href="../docker/creating-the-perfect-python-dockerfile.html">Perfect python dockerfile</a></li><li class="chapter-item "><a href="../docker/dockerfile-from-docker-image.html">由 Docker image 反推其 Dockerfile</a></li><li class="chapter-item "><a href="../docker/python_connect_redis.html">Python連接Redis</a></li><li class="chapter-item "><a href="../docker/command.html">Command</a></li><li class="chapter-item "><a href="../docker/docker_compose.html">Docker compose</a></li><li class="chapter-item "><a href="../docker/docker_compse_example.html">Docker compose example</a></li><li class="chapter-item "><a href="../docker/python_redis.html">Python-Redis</a></li><li class="chapter-item "><a href="../docker/redash.html">Redash</a></li><li class="chapter-item "><a href="../docker/clickhouse.html">ClickHouse</a></li><li class="chapter-item "><a href="../docker/clickhouse-setup.html">clickhouse-setup</a></li></ol></li><li class="chapter-item expanded "><a href="../rust/rust.html">Rust</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../rust/note.html">Rust筆記</a></li><li class="chapter-item "><a href="../rust/basic.html">Rust 基本教學</a></li><li class="chapter-item "><a href="../rust/ownership.html">Rust 所有權系統</a></li><li class="chapter-item "><a href="../rust/lifetime.html">Rust 生命週期 (Lifetime)</a></li><li class="chapter-item "><a href="../rust/type.html">Rust 型別系統</a></li><li class="chapter-item "><a href="../rust/polars.html">Polars</a></li><li class="chapter-item "><a href="../rust/rust_call_c.html">Rust call C</a></li><li class="chapter-item "><a href="../rust/10-rust-an-introduction.html">給 C++ 使用者的 Rust 簡介</a></li><li class="chapter-item "><a href="../rust/可視化Rust各資料結構的記憶體佈局.html">可視化Rust各資料結構的記憶體佈局</a></li><li class="chapter-item "><a href="../rust/rust_note.html">學習順序</a></li><li class="chapter-item "><a href="../rust/overview.html">大局觀</a></li><li class="chapter-item "><a href="../rust/String.html">理解字串</a></li><li class="chapter-item "><a href="../rust/easy_rust.html">Easy Rust</a></li><li class="chapter-item "><a href="../rust/rust_easy.html">Rust 新手</a></li><li class="chapter-item "><a href="../rust/module.html">Rust 模組結構</a></li><li class="chapter-item "><a href="../rust/rust_memory.html">Rust與記憶體</a></li><li class="chapter-item "><a href="../rust/rust_vs_cpp.html">Rust vs C++語法</a></li><li class="chapter-item "><a href="../rust/rust_file_format.html">Rust 檔案格式</a></li><li class="chapter-item "><a href="../rust/binary_lib.html">Rust 函數庫/執行檔</a></li><li class="chapter-item "><a href="../rust/print-function-name-dump-stack.html">印出函數名稱</a></li><li class="chapter-item "><a href="../rust/note.html">30天深入淺出Rust系列</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../rust/30天深入淺出Rust系列/rust_30_day.html">Rust 30 Day</a></li><li class="chapter-item "><a href="../rust/30天深入淺出Rust系列/Move_Borrow_Ownership.html">變數的所有權與借出變數</a></li><li class="chapter-item "><a href="../rust/30天深入淺出Rust系列/Lifetime.html">Lifetime： Borrow 的存活時間</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../go/go.html">Go</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../go/note.html">Golang  Note</a></li><li class="chapter-item "><a href="../go/pytago.html">pytago</a></li><li class="chapter-item "><a href="../go/Go編程實戰派基礎入門.html">Go編程實戰派基礎入門</a></li><li class="chapter-item "><a href="../go/Go編程實戰派Web開發基礎.html">Go編程實戰派Web開發基礎</a></li><li class="chapter-item "><a href="../go/golang_debugger.html">Golang Deubgger</a></li><li class="chapter-item "><a href="../go/golang-go-module-tutorial.html">從一知半解到略懂 Go modules</a></li><li class="chapter-item "><a href="../go/go_mod.html">Go modules</a></li><li class="chapter-item "><a href="../go/trace.html">Golang大殺器之跟蹤剖析trace</a></li><li class="chapter-item "><a href="../go/Coroutine.html">行程、執行緒、協程，傻傻分得清楚！</a></li><li class="chapter-item "><a href="../go/goroutine-and-channel.html">Go併發</a></li><li class="chapter-item "><a href="../go/websocket.html">Websocket</a></li><li class="chapter-item "><a href="../go/returning-pointer-from-a-function-in-go.html">Returning Pointer from a Function in Go</a></li><li class="chapter-item "><a href="../go/golang-memory-management.html">GC 全面解析</a></li><li class="chapter-item "><a href="../go/golang-goroutine.html">Goroutine 與 GMP 原理全面分析</a></li><li class="chapter-item "><a href="../go/oo.html">OO</a></li><li class="chapter-item "><a href="../go/mutex-rwmutex.html">sync.Mutex 和 sync.RWMutex</a></li><li class="chapter-item "><a href="../go/interface.html">interface</a></li><li class="chapter-item "><a href="../go/example.html">Example</a></li></ol></li><li class="chapter-item expanded "><a href="../ml/ml.html">ML</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../ml/pytorch.html">Pytorch</a></li></ol></li><li class="chapter-item expanded "><a href="../python/python.html">Python</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../python/Poetry完全入門指南.html">Poetry完全入門指南</a></li><li class="chapter-item "><a href="../python/搭建gRPC服務.html">搭建gRPC服務</a></li><li class="chapter-item "><a href="../python/python_debugger.html">Python Debugger</a></li><li class="chapter-item "><a href="../python/decorator.html">Python decorator</a></li><li class="chapter-item "><a href="../python/python-decorator.html">裝飾器看這一篇就夠了</a></li><li class="chapter-item "><a href="../python/import-concept.html">import-concept</a></li><li class="chapter-item "><a href="../python/process_thread.html">Process/Thread優缺點</a></li><li class="chapter-item "><a href="../python/processing_communcation.html">Processing 通訊</a></li><li class="chapter-item "><a href="../python/condition.html">Python中的wait和notify</a></li><li class="chapter-item "><a href="../python/生產者消費者模式.html">生產者消費者模式</a></li><li class="chapter-item "><a href="../python/Loguru.html">Loguru</a></li><li class="chapter-item "><a href="../python/WebSocket_reconnect.html">Python WebSocket長連接心跳與短連接</a></li><li class="chapter-item "><a href="../python/bloomrpc.html">bloomrpc</a></li><li class="chapter-item "><a href="../python/concurrent.futures.html">Concurrent futures</a></li><li class="chapter-item "><a href="../python/schedule.html">任務調度</a></li><li class="chapter-item "><a href="../python/plot/plot.html">Plot</a></li><li class="chapter-item "><a href="../python/plot/dash.html">Dash</a></li><li class="chapter-item "><a href="../python/Rust_bindings_for_Python.html">Rust bindings for Python</a></li><li class="chapter-item "><a href="../python/pandas.html">Pandas</a></li><li class="chapter-item "><a href="../python/coroutine.html">Coroutine</a></li><li class="chapter-item "><a href="../python/finmind.html">FinMind</a></li><li class="chapter-item "><a href="../python/telegram_bot.html">Telegram Bot</a></li><li class="chapter-item "><a href="../python/websocket_client_server.html">Websocket client/server</a></li><li class="chapter-item "><a href="../python/poetry.html">從零開始使用 Poetry</a></li><li class="chapter-item "><a href="../python/fil-memory-usage-profiler.html">Fil-memory-usage-profiler</a></li><li class="chapter-item "><a href="../python/plot.html">繪圖</a></li><li class="chapter-item "><a href="../python/shioaji.html">永豐shioaji</a></li><li class="chapter-item "><a href="../python/other.html">Other</a></li></ol></li><li class="chapter-item expanded "><a href="../mermaid/mermaid.html">Mermaid</a></li><li class="chapter-item expanded "><a href="../linux_system/perf.html">Linux System</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../linux_system/1_day_socket.html">Socket</a></li><li class="chapter-item "><a href="../linux_system/cgroup.html">Cgroup</a></li><li class="chapter-item "><a href="../linux_system/perf.html">Perf</a></li></ol></li><li class="chapter-item expanded "><a href="../strategy/bollmaker.html">Strategy</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../strategy/造市/market_market.html">造市</a></li><li class="chapter-item "><a href="../strategy/tw_futures.html">臺指</a></li><li class="chapter-item "><a href="../strategy/arbitrage.html">套利</a></li><li class="chapter-item "><a href="../strategy/海龜交易.html">海龜交易</a></li><li class="chapter-item "><a href="../strategy/如何避免過擬合.html">如何避免過擬合</a></li><li class="chapter-item "><a href="../strategy/Option/option.html">選擇權</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../strategy/Option/option_note.html">Option note</a></li></ol></li><li class="chapter-item "><a href="../strategy/vectorbt.html">VectorBT</a></li><li class="chapter-item "><a href="../strategy/orderbook.html">Orderbook</a></li><li class="chapter-item "><a href="../strategy/選股條件.html">選股條件</a></li><li class="chapter-item "><a href="../strategy/如何進場.html">如何進場</a></li><li class="chapter-item "><a href="../strategy/如何出場.html">如何出場</a></li><li class="chapter-item "><a href="../strategy/建倉加碼.html">建倉加碼</a></li><li class="chapter-item "><a href="../strategy/Book/JG.html">JG</a></li><li class="chapter-item "><a href="../strategy/bnf.html">BNF</a></li><li class="chapter-item "><a href="../strategy/cis.html">CIS</a></li><li class="chapter-item "><a href="../strategy/stock.html">Stock</a></li><li class="chapter-item "><a href="../strategy/note.html">Resource</a></li><li class="chapter-item "><a href="../strategy/nansen.html">Nansen</a></li><li class="chapter-item "><a href="../strategy/example.html">Example</a></li><li class="chapter-item "><a href="../strategy/other.html">Other</a></li><li class="chapter-item "><a href="../strategy/sample.html">Sample</a></li><li class="chapter-item "><a href="../strategy/grid.html">Grid</a></li><li class="chapter-item expanded "><a href="../strategy/pine-script.html" class="active">pine-script</a></li><li class="chapter-item "><a href="../strategy/阿老師.html">阿老師</a></li><li class="chapter-item "><a href="../strategy/sharpe_ratio.html">夏普值</a></li><li class="chapter-item "><a href="../strategy/display_mae_mfe_analysis.html">MAE&amp;MFE分析</a></li><li class="chapter-item "><a href="../strategy/海龜投資法則.html">海龜投資法則</a></li><li class="chapter-item "><a href="../strategy/edge-ratio-follow-application.html">彈性進出場的判斷</a></li><li class="chapter-item "><a href="../strategy/finlab.html">Finlab</a></li><li class="chapter-item "><a href="../strategy/backtrader/basis.html">Backtrader</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../strategy/backtrader/Python回測框架一Backtrader介紹.html">Python回測框架一Backtrader介紹</a></li><li class="chapter-item "><a href="../strategy/backtrader/Python回測框架二定期定額投資.html">Python 回測框架（二）定期定額投資</a></li><li class="chapter-item "><a href="../strategy/backtrader/Python回測框架三技術指標.html">Python 回測框架（三）技術指標</a></li><li class="chapter-item "><a href="../strategy/backtrader/Python回測框架四CrossOver和Signal.html">Python 回測框架（四）CrossOver 和 Signal</a></li><li class="chapter-item "><a href="../strategy/backtrader/Python回測框架五Sizer.html">Python 回測框架（五）Sizer</a></li><li class="chapter-item "><a href="../strategy/backtrader/Python回測框架六Analyzers.html">Python 回測框架（六）Analyzers</a></li><li class="chapter-item "><a href="../strategy/backtrader/多股組合操作策略.html">多股組合操作</a></li><li class="chapter-item "><a href="../strategy/backtrader/均線交叉策略.html">均線交叉策略</a></li><li class="chapter-item "><a href="../strategy/backtrader/唐奇安通道策略.html">唐奇安通道策略</a></li><li class="chapter-item "><a href="../strategy/backtrader/Sizers模組.html">Sizers模組</a></li><li class="chapter-item "><a href="../strategy/backtrader/Observers模組.html">Observers模組</a></li><li class="chapter-item "><a href="../strategy/backtrader/Pyfolio.html">Pyfolio</a></li><li class="chapter-item "><a href="../strategy/backtrader/Sample.html">Sample</a></li><li class="chapter-item "><a href="../strategy/backtrader/performance.html">Performance</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../mq/kafka.html">MQ</a></li><li class="chapter-item expanded "><a href="../mq/kafka-python.html">Kafka的通俗總結</a></li><li class="chapter-item expanded "><a href="../database/redis.html">Database</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../database/redis.html">Redis</a></li><li class="chapter-item "><a href="../database/hash.html">Redis Hash</a></li><li class="chapter-item "><a href="../database/clickhouse.html">ClickHouse</a></li><li class="chapter-item "><a href="../database/dolphin.html">Dolphin</a></li><li class="chapter-item "><a href="../database/sqlite.html">Sqlite</a></li></ol></li><li class="chapter-item expanded "><a href="../cryptotrade/cryptotrade.html">CryptoTrade</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../cryptotrade/binance/binance.html">Binance</a></li><li class="chapter-item "><a href="../cryptotrade/binance/oco.html">如何將OCO訂單發送到Binance</a></li></ol></li><li class="chapter-item expanded "><a href="../git/git.html">Git</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../git/git-remove-commited-files.html">git-remove-commited-files</a></li><li class="chapter-item "><a href="../git/cheat-sheet.html">Git 常用</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="pine語言學習指令碼"><a class="header" href="#pine語言學習指令碼">pine語言學習指令碼</a></h2>
<pre><code class="language-sh">//@version=4
study(&quot;SMA Trend Strategy&quot;)

// 設置參數
fastLength = input(title=&quot;Fast Length&quot;, type=input.integer, defval=10)
slowLength = input(title=&quot;Slow Length&quot;, type=input.integer, defval=20)

// 計算指標
fastSMA = sma(close, fastLength)
slowSMA = sma(close, slowLength)

// 設置止盈止損
longStop = strategy.position_avg_price * (1 - 0.01)
shortStop = strategy.position_avg_price * (1 + 0.01)
longlimit = strategy.position_avg_price * (1 + 0.01)
shortlimit = strategy.position_avg_price * (1 - 0.01)

// 開倉條件
longCondition = crossover(fastSMA, slowSMA)
shortCondition = crossunder(fastSMA, slowSMA)

// 開倉
strategy.entry(&quot;Long&quot;, strategy.long, when=longCondition)
strategy.entry(&quot;Short&quot;, strategy.short, when=shortCondition)

// 止盈止損
strategy.exit(&quot;Long Stop&quot;, &quot;Long&quot;, stop=longStop,limit=longlimit)
strategy.exit(&quot;Short Stop&quot;, &quot;Short&quot;, stop=shortStop,limit=shortlimit)
</code></pre>
<h1 id="the-art-of-trading"><a class="header" href="#the-art-of-trading"><a href="https://www.youtube.com/c/TheArtofTrading">The Art of Trading</a></a></h1>
<p>https://courses.theartoftrading.com/pages/pine-script-mastery-code#strategy1</p>
<p>https://www.youtube.com/watch?v=h-erJbnBj6A&amp;feature=youtu.be</p>
<h2 id="how-to-create-a-regime-filter"><a class="header" href="#how-to-create-a-regime-filter">How To Create A Regime Filter</a></h2>
<p><a href="https://youtu.be/MV61WcTkV54">Watch Lesson</a></p>
<pre><code class="language-python">// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © ZenAndTheArtOfTrading / www.PineScriptMastery.com
// @version=5
indicator(&quot;Regime Filter&quot;)

// Get user input
res = input.timeframe(title=&quot;Timeframe&quot;, defval=&quot;D&quot;)
len = input.int(title=&quot;EMA Length&quot;, defval=20)
market = input.symbol(title=&quot;Market&quot;, defval=&quot;NASDAQ:NDX&quot;)

// Define custom security function
f_sec(_market, _res, _exp) =&gt; request.security(_market, _res, _exp[barstate.isconfirmed ? 0 : 1])

// Get EMA value
ema = ta.ema(close, len)
emaValue = f_sec(market, res, ema)

// Check if price is above or below EMA filter
marketPrice = f_sec(market, res, close)
regimeFilter = marketPrice &gt; emaValue or marketPrice[1] &gt; emaValue[1]

// Change background color
bgcolor(regimeFilter ? color.green : color.red)
</code></pre>
<h2 id="auto-fibonacci-tool"><a class="header" href="#auto-fibonacci-tool">AUTO-FIBONACCI Tool</a></h2>
<p><a href="https://youtu.be/SdYHqTlsDWo">Watch Lesson</a></p>
<pre><code class="language-python">// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © ZenAndTheArtOfTrading / PineScriptMastery.com
// @version=5
indicator(&quot;Auto-Fib&quot;, overlay=true)

// Get user input
var devTooltip          = &quot;Deviation is a multiplier that affects how much the price should deviate from the previous pivot in order for the bar to become a new pivot.&quot;
var depthTooltip        = &quot;The minimum number of bars that will be taken into account when calculating the indicator.&quot;
threshold_multiplier    = input.float(title=&quot;Deviation&quot;, defval=3, minval=0, tooltip=devTooltip)
depth                   = input.int(title=&quot;Depth&quot;, defval=10, minval=1, tooltip=depthTooltip)
reverse                 = input.bool(title=&quot;Reverse&quot;, defval=false, tooltip=&quot;Flips the fibonacci levels around.&quot;)
extendLeft              = input.bool(title=&quot;Extend Left    |    Extend Right&quot;, defval=false, inline=&quot;Extend Lines&quot;)
extendRight             = input.bool(title=&quot;&quot;, defval=false, inline=&quot;Extend Lines&quot;)
prices                  = input.bool(title=&quot;Show Prices&quot;, defval=false)
deleteLastLine          = input.bool(title=&quot;Delete Last Line&quot;, defval=true)
levels                  = input.bool(title=&quot;Show Levels&quot;, defval=true, inline=&quot;Levels&quot;)
levelsFormat            = input.string(title=&quot;&quot;, defval=&quot;Values&quot;, options=[&quot;Values&quot;, &quot;Percent&quot;], inline=&quot;Levels&quot;)
labelsPosition          = input.string(title=&quot;Labels Position&quot;, defval=&quot;Left&quot;, options=[&quot;Left&quot;, &quot;Right&quot;])
backgroundTransparency  = input.int(title=&quot;Background Transparency&quot;, defval=85, minval=0, maxval=100)

// Check extending parameter
var extending = extend.none
if extendLeft and extendRight
    extending := extend.both
if extendLeft and not extendRight
    extending := extend.left
if not extendLeft and extendRight
    extending := extend.right

// Calculate deviation threshold for identifying major swings
dev_threshold = ta.atr(10) / close * 100 * threshold_multiplier

// Prepare pivot variables
var line lineLast = na
var int iLast = 0
var int iPrev = 0
var float pLast = 0
var isHighLast = false // Otherwise the last pivot is a low pivot

// Custom function for detecting pivot points
pivots(src, length, isHigh) =&gt;
    l2 = length * 2
    c = nz(src[length])
    ok = true
    for i = 0 to l2
        if isHigh and src[i] &gt; c
            ok := false
        if not isHigh and src[i] &lt; c
            ok := false
    if ok
        [bar_index[length], c]
    else
        [int(na), float(na)]

// Get bar index &amp; price high/low for current pivots
[iH, pH] = pivots(high, depth / 2, true)
[iL, pL] = pivots(low, depth / 2, false)

// Custom function for calculating price deviation
calc_dev(base_price, price) =&gt; 100 * (price - base_price) / price

// Custom function for detecting pivots that meet our deviation criteria
pivotFound(dev, isHigh, index, price) =&gt;
    if isHighLast == isHigh and not na(lineLast)
        // New pivot in same direction as last, so update line (ie. trend-continuation)
        if isHighLast ? price &gt; pLast : price &lt; pLast
            line.set_xy2(lineLast, index, price)
            [lineLast, isHighLast]
        else
            [line(na), bool(na)] // No valid pivot detected, return nothing
    else // Reverse the trend/pivot direction (or create the very first line if lineLast is na)
        if math.abs(dev) &gt; dev_threshold
            // Price move is significant - create a new line between the pivot points
            id = line.new(iLast, pLast, index, price, color=color.gray, width=1, style=line.style_dashed)
            [id, isHigh]
        else
            [line(na), bool(na)]

// If bar index for current pivot high is not NA (ie. we have a new pivot):
if not na(iH)
    dev = calc_dev(pLast, pH) // Calculate the deviation from last pivot
    [id, isHigh] = pivotFound(dev, true, iH, pH)
    if not na(id) // If the line has been updated, update price values and delete previous line
        if id != lineLast and deleteLastLine
            line.delete(lineLast)
        lineLast := id
        isHighLast := isHigh
        iPrev := iLast
        iLast := iH
        pLast := pH
else 
    if not na(iL) // If bar index for current pivot low is not NA (ie. we have a new pivot):
        dev = calc_dev(pLast, pL) // Calculate the deviation from last pivot
        [id, isHigh] = pivotFound(dev, false, iL, pL)
        if not na(id) // If the line has been updated, update price values and delete previous line
            if id != lineLast and deleteLastLine
                line.delete(lineLast)
            lineLast := id
            isHighLast := isHigh
            iPrev := iLast
            iLast := iL
            pLast := pL

// Draw fibonacci level as a line and return the line object ID
draw_fib_line(price, col) =&gt;
    var id = line.new(iLast, price, bar_index, price, color=col, width=1, extend=extending)
    if not na(lineLast)
        line.set_xy1(id, line.get_x1(lineLast), price)
        line.set_xy2(id, line.get_x2(lineLast), price)  
	id  

// Draw fibonacci labels
draw_label(price, txt, txtColor) =&gt;
    x = labelsPosition == &quot;Left&quot; ? line.get_x1(lineLast) : not extendRight ? line.get_x2(lineLast) : bar_index
    labelStyle = labelsPosition == &quot;Left&quot; ? label.style_label_right : label.style_label_left
    align = labelsPosition == &quot;Left&quot; ? text.align_right : text.align_left
    labelsAlignStrLeft = txt + '\n ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏ \n'
    labelsAlignStrRight = '       ' + txt + '\n ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏  ‏ \n'
    labelsAlignStr = labelsPosition == &quot;Left&quot; ? labelsAlignStrLeft : labelsAlignStrRight
    var id = label.new(x=x, y=price, text=labelsAlignStr, textcolor=txtColor, style=labelStyle, textalign=align, color=#00000000)
    label.set_xy(id, x, price)
    label.set_text(id, labelsAlignStr)
    label.set_textcolor(id, txtColor)

// Format the given string
format(txt) =&gt; &quot; (&quot; + str.tostring(txt, &quot;#.####&quot;) + &quot;)&quot;

// Return the formatted label text for Fibonacci levels
label_txt(level, price) =&gt;
    l = levelsFormat == &quot;Values&quot; ? str.tostring(level) : str.tostring(level * 100) + &quot;%&quot;
    (levels ? l : &quot;&quot;) + (prices ? format(price) : &quot;&quot;)

// Returns true if price is crossing the given fib level
crossing_level(price, fib) =&gt; (fib &gt; price and fib &lt; price[1]) or (fib &lt; price and fib &gt; price[1])

// Get starting and ending high/low price of the current pivot (for calculating fib levels)
startPrice = reverse ? line.get_y1(lineLast) : pLast
endPrice = reverse ? pLast : line.get_y1(lineLast)

// Calculate price difference between high and low
iHL = startPrice &gt; endPrice
diff = (iHL ? -1 : 1) * math.abs(startPrice - endPrice)

// Process the given fib level (calculate fib, draw line &amp; label, detect alerts, fill bgcolor between last fib)
processLevel(show, value, colorL, lineIdOther) =&gt;
    if show
	    fibPrice = startPrice + diff * value
		lineId = draw_fib_line(fibPrice, colorL)
        draw_label(fibPrice, label_txt(value, fibPrice), colorL)
        if crossing_level(close, fibPrice) // Trigger alert if price is crossing this fib level
            alert(&quot;Autofib: &quot; + syminfo.ticker + &quot; crossing level &quot; + str.tostring(value))
        if not na(lineIdOther) // Fill background color between each fib level
            linefill.new(lineId, lineIdOther, color=color.new(colorL, backgroundTransparency))
		lineId
    else
		lineIdOther

//{=============================================================================
var g_fibs = &quot;Fibonacci Levels&quot;
// Get Fibonacci level user inputs
show_0 = input(true, &quot;&quot;, inline = &quot;Level0&quot;, group=g_fibs)
value_0 = input(0, &quot;&quot;, inline = &quot;Level0&quot;, group=g_fibs)
color_0 = input(#787b86, &quot;&quot;, inline = &quot;Level0&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_0_236 = input(true, &quot;&quot;, inline = &quot;Level0&quot;, group=g_fibs)
value_0_236 = input(0.236, &quot;&quot;, inline = &quot;Level0&quot;, group=g_fibs)
color_0_236 = input(#f44336, &quot;&quot;, inline = &quot;Level0&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_0_382 = input(true, &quot;&quot;, inline = &quot;Level1&quot;, group=g_fibs)
value_0_382 = input(0.382, &quot;&quot;, inline = &quot;Level1&quot;, group=g_fibs)
color_0_382 = input(#81c784, &quot;&quot;, inline = &quot;Level1&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_0_5 = input(true, &quot;&quot;, inline = &quot;Level1&quot;, group=g_fibs)
value_0_5 = input(0.5, &quot;&quot;, inline = &quot;Level1&quot;, group=g_fibs)
color_0_5 = input(#4caf50, &quot;&quot;, inline = &quot;Level1&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_0_618 = input(true, &quot;&quot;, inline = &quot;Level2&quot;, group=g_fibs)
value_0_618 = input(0.618, &quot;&quot;, inline = &quot;Level2&quot;, group=g_fibs)
color_0_618 = input(#009688, &quot;&quot;, inline = &quot;Level2&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_0_65 = input(false, &quot;&quot;, inline = &quot;Level2&quot;, group=g_fibs)
value_0_65 = input(0.65, &quot;&quot;, inline = &quot;Level2&quot;, group=g_fibs)
color_0_65 = input(#009688, &quot;&quot;, inline = &quot;Level2&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_0_786 = input(true, &quot;&quot;, inline = &quot;Level3&quot;, group=g_fibs)
value_0_786 = input(0.786, &quot;&quot;, inline = &quot;Level3&quot;, group=g_fibs)
color_0_786 = input(#64b5f6, &quot;&quot;, inline = &quot;Level3&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_1 = input(true, &quot;&quot;, inline = &quot;Level3&quot;, group=g_fibs)
value_1 = input(1, &quot;&quot;, inline = &quot;Level3&quot;, group=g_fibs)
color_1 = input(#787b86, &quot;&quot;, inline = &quot;Level3&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_1_272 = input(false, &quot;&quot;, inline = &quot;Level4&quot;, group=g_fibs)
value_1_272 = input(1.272, &quot;&quot;, inline = &quot;Level4&quot;, group=g_fibs)
color_1_272 = input(#81c784, &quot;&quot;, inline = &quot;Level4&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_1_414 = input(false, &quot;&quot;, inline = &quot;Level4&quot;, group=g_fibs)
value_1_414 = input(1.414, &quot;&quot;, inline = &quot;Level4&quot;, group=g_fibs)
color_1_414 = input(#f44336, &quot;&quot;, inline = &quot;Level4&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_1_618 = input(false, &quot;&quot;, inline = &quot;Level5&quot;, group=g_fibs)
value_1_618 = input(1.618, &quot;&quot;, inline = &quot;Level5&quot;, group=g_fibs)
color_1_618 = input(#2196f3, &quot;&quot;, inline = &quot;Level5&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_1_65 = input(false, &quot;&quot;, inline = &quot;Level5&quot;, group=g_fibs)
value_1_65 = input(1.65, &quot;&quot;, inline = &quot;Level5&quot;, group=g_fibs)
color_1_65 = input(#2196f3, &quot;&quot;, inline = &quot;Level5&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_2_618 = input(false, &quot;&quot;, inline = &quot;Level6&quot;, group=g_fibs)
value_2_618 = input(2.618, &quot;&quot;, inline = &quot;Level6&quot;, group=g_fibs)
color_2_618 = input(#f44336, &quot;&quot;, inline = &quot;Level6&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_2_65 = input(false, &quot;&quot;, inline = &quot;Level6&quot;, group=g_fibs)
value_2_65 = input(2.65, &quot;&quot;, inline = &quot;Level6&quot;, group=g_fibs)
color_2_65 = input(#f44336, &quot;&quot;, inline = &quot;Level6&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_3_618 = input(false, &quot;&quot;, inline = &quot;Level7&quot;, group=g_fibs)
value_3_618 = input(3.618, &quot;&quot;, inline = &quot;Level7&quot;, group=g_fibs)
color_3_618 = input(#9c27b0, &quot;&quot;, inline = &quot;Level7&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_3_65 = input(false, &quot;&quot;, inline = &quot;Level7&quot;, group=g_fibs)
value_3_65 = input(3.65, &quot;&quot;, inline = &quot;Level7&quot;, group=g_fibs)
color_3_65 = input(#9c27b0, &quot;&quot;, inline = &quot;Level7&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_4_236 = input(false, &quot;&quot;, inline = &quot;Level8&quot;, group=g_fibs)
value_4_236 = input(4.236, &quot;&quot;, inline = &quot;Level8&quot;, group=g_fibs)
color_4_236 = input(#e91e63, &quot;&quot;, inline = &quot;Level8&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_4_618 = input(false, &quot;&quot;, inline = &quot;Level8&quot;, group=g_fibs)
value_4_618 = input(4.618, &quot;&quot;, inline = &quot;Level8&quot;, group=g_fibs)
color_4_618 = input(#81c784, &quot;&quot;, inline = &quot;Level8&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_neg_0_236 = input(false, &quot;&quot;, inline = &quot;Level9&quot;, group=g_fibs)
value_neg_0_236 = input(-0.236, &quot;&quot;, inline = &quot;Level9&quot;, group=g_fibs)
color_neg_0_236 = input(#f44336, &quot;&quot;, inline = &quot;Level9&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_neg_0_382 = input(false, &quot;&quot;, inline = &quot;Level9&quot;, group=g_fibs)
value_neg_0_382 = input(-0.382, &quot;&quot;, inline = &quot;Level9&quot;, group=g_fibs)
color_neg_0_382 = input(#81c784, &quot;&quot;, inline = &quot;Level9&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_neg_0_618 = input(false, &quot;&quot;, inline = &quot;Level10&quot;, group=g_fibs)
value_neg_0_618 = input(-0.618, &quot;&quot;, inline = &quot;Level10&quot;, group=g_fibs)
color_neg_0_618 = input(#009688, &quot;&quot;, inline = &quot;Level10&quot;, group=g_fibs)
//------------------------------------------------------------------------------
show_neg_0_65 = input(false, &quot;&quot;, inline = &quot;Level10&quot;, group=g_fibs)
value_neg_0_65 = input(-0.65, &quot;&quot;, inline = &quot;Level10&quot;, group=g_fibs)
color_neg_0_65 = input(#009688, &quot;&quot;, inline = &quot;Level10&quot;, group=g_fibs)
//-----------------------------------------------------------------------------}
//{=============================================================================
// Process each fibonacci level
//==============================================================================
lineId0  = processLevel(show_neg_0_65, value_neg_0_65, color_neg_0_65, line(na))
lineId1  = processLevel(show_neg_0_618, value_neg_0_618, color_neg_0_618, lineId0)
lineId2  = processLevel(show_neg_0_382, value_neg_0_382, color_neg_0_382, lineId1)
lineId3  = processLevel(show_neg_0_236, value_neg_0_236, color_neg_0_236, lineId2)
lineId4  = processLevel(show_0, value_0, color_0, lineId3)
lineId5  = processLevel(show_0_236, value_0_236, color_0_236, lineId4)
lineId6  = processLevel(show_0_382, value_0_382, color_0_382, lineId5)
lineId7  = processLevel(show_0_5, value_0_5, color_0_5, lineId6)
lineId8  = processLevel(show_0_618, value_0_618, color_0_618, lineId7)
lineId9  = processLevel(show_0_65, value_0_65, color_0_65, lineId8)
lineId10 = processLevel(show_0_786, value_0_786, color_0_786, lineId9)
lineId11 = processLevel(show_1, value_1, color_1, lineId10)
lineId12 = processLevel(show_1_272, value_1_272, color_1_272, lineId11)
lineId13 = processLevel(show_1_414, value_1_414, color_1_414, lineId12)
lineId14 = processLevel(show_1_618, value_1_618, color_1_618, lineId13)
lineId15 = processLevel(show_1_65, value_1_65, color_1_65, lineId14)
lineId16 = processLevel(show_2_618, value_2_618, color_2_618, lineId15)
lineId17 = processLevel(show_2_65, value_2_65, color_2_65, lineId16)
lineId18 = processLevel(show_3_618, value_3_618, color_3_618, lineId17)
lineId19 = processLevel(show_3_65, value_3_65, color_3_65, lineId18)
lineId20 = processLevel(show_4_236, value_4_236, color_4_236, lineId19)
lineId21 = processLevel(show_4_618, value_4_618, color_4_618, lineId20)
//-----------------------------------------------------------------------------}
</code></pre>
<h2 id="pivots--impulsive-moves"><a class="header" href="#pivots--impulsive-moves">Pivots &amp; Impulsive Moves</a></h2>
<p><a href="https://youtu.be/5I8rLVvcbok">Watch Lesson</a></p>
<pre><code class="language-python">// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © ZenAndTheArtOfTrading / PineScriptMastery.com
// @version=5
indicator(&quot;Pivot Points&quot;, overlay=true)

// Get user input
var devTooltip          = &quot;Deviation is a multiplier that affects how much the price should deviate from the previous pivot in order for the bar to become a new pivot.&quot;
var depthTooltip        = &quot;The minimum number of bars that will be taken into account when analyzing pivots.&quot;
threshold_multiplier    = input.float(title=&quot;Deviation&quot;, defval=2.5, minval=0, tooltip=devTooltip)
depth                   = input.int(title=&quot;Depth&quot;, defval=10, minval=1, tooltip=depthTooltip)
deleteLastLine          = input.bool(title=&quot;Delete Last Line&quot;, defval=false)
bgcolorChange           = input.bool(title=&quot;Change BgColor&quot;, defval=false)

// Calculate deviation threshold for identifying major swings
dev_threshold = ta.atr(10) / close * 100 * threshold_multiplier

// Prepare pivot variables
var line lineLast = na
var int iLast = 0 // Index last
var int iPrev = 0 // Index previous
var float pLast = 0 // Price last
var isHighLast = false // If false then the last pivot was a pivot low

// Custom function for detecting pivot points (and returning price + bar index)
pivots(src, length, isHigh) =&gt;
    l2 = length * 2
    c = nz(src[length])
    ok = true
    for i = 0 to l2
        if isHigh and src[i] &gt; c // If isHigh, validate pivot high
            ok := false
        if not isHigh and src[i] &lt; c // If not isHigh, validate pivot low
            ok := false
    if ok // If pivot is valid, return bar index + high price value
        [bar_index[length], c]
    else // If pivot is invalid, return na
        [int(na), float(na)]

// Get bar index &amp; price high/low for current pivots
[iH, pH] = pivots(high, depth / 2, true)
[iL, pL] = pivots(low, depth / 2, false)

// Custom function for calculating price deviation for validating large moves
calc_dev(base_price, price) =&gt; 100 * (price - base_price) / price

// Custom function for detecting pivots that meet our deviation criteria
pivotFound(dev, isHigh, index, price) =&gt;
    if isHighLast == isHigh and not na(lineLast) // Check bull/bear direction of new pivot
        // New pivot in same direction as last (a pivot high), so update line upwards (ie. trend-continuation)
        if isHighLast ? price &gt; pLast : price &lt; pLast // If new pivot is above last pivot, update line
            line.set_xy2(lineLast, index, price)
            [lineLast, isHighLast]
        else
            [line(na), bool(na)] // New pivot is not above last pivot, so don't update the line
    else // Reverse the trend/pivot direction (or create the very first line if lineLast is na)
        if math.abs(dev) &gt; dev_threshold
            // Price move is significant - create a new line between the pivot points
            id = line.new(iLast, pLast, index, price, color=color.gray, width=1, style=line.style_dashed)
            [id, isHigh]
        else
            [line(na), bool(na)]

// If bar index for current pivot high is not NA (ie. we have a new pivot):
if not na(iH)
    dev = calc_dev(pLast, pH) // Calculate the deviation from last pivot
    [id, isHigh] = pivotFound(dev, true, iH, pH) // Pass the current pivot high into pivotFound() for validation &amp; line update
    if not na(id) // If the line has been updated, update price &amp; index values and delete previous line
        if id != lineLast and deleteLastLine
            line.delete(lineLast)
        lineLast := id
        isHighLast := isHigh
        iPrev := iLast
        iLast := iH
        pLast := pH
else 
    if not na(iL) // If bar index for current pivot low is not NA (ie. we have a new pivot):
        dev = calc_dev(pLast, pL) // Calculate the deviation from last pivot
        [id, isHigh] = pivotFound(dev, false, iL, pL) // Pass the current pivot low into pivotFound() for validation &amp; line update
        if not na(id) // If the line has been updated, update price values and delete previous line
            if id != lineLast and deleteLastLine
                line.delete(lineLast)
            lineLast := id
            isHighLast := isHigh
            iPrev := iLast
            iLast := iL
            pLast := pL

// Get starting and ending high/low price of the current pivot line
startIndex = line.get_x1(lineLast)
startPrice = line.get_y1(lineLast)
endIndex   = line.get_x2(lineLast)
endPrice   = line.get_y2(lineLast)

// Draw top &amp; bottom of impulsive move
topLine    = line.new(startIndex, startPrice, endIndex, startPrice, extend=extend.right, color=color.red)
bottomline = line.new(startIndex, endPrice, endIndex, endPrice, extend=extend.right, color=color.green)
line.delete(topLine[1])
line.delete(bottomline[1])
//plot(startPrice, color=color.green)
//plot(endPrice, color=color.red)

// Do what you like with these pivot values :)
// Keep in mind there will be an X bar delay between pivot price values updating based on Depth setting
dist = math.abs(startPrice - endPrice)
plot(dist, color=color.new(color.purple,100))
bullish = endPrice &gt; startPrice
offsetBG = -(depth / 2)
bgcolor(bgcolorChange ? bullish ? color.new(color.green,90) : color.new(color.red,90) : na, offset=offsetBG)
</code></pre>
<h2 id="tracking-ichimoku-base-line"><a class="header" href="#tracking-ichimoku-base-line">Tracking Ichimoku Base Line</a></h2>
<p><a href="https://youtu.be/yPiys6dJF4M">Watch Lesson</a></p>
<pre><code class="language-python">// PineScriptMastery.com
// @version=5
indicator(title=&quot;Ichimoku Cloud&quot;, shorttitle=&quot;Ichimoku&quot;, overlay=true)

// Get user input
conversionPeriods       = input.int(9, minval=1, title=&quot;Conversion Line Length&quot;)
basePeriods             = input.int(26, minval=1, title=&quot;Base Line Length&quot;)
laggingSpan2Periods     = input.int(52, minval=1, title=&quot;Leading Span B Length&quot;)
displacement            = input.int(26, minval=1, title=&quot;Lagging Span&quot;)
donchian(len)           =&gt; math.avg(ta.lowest(len), ta.highest(len))
conversionLine          = donchian(conversionPeriods)
baseLine                = donchian(basePeriods)
leadLine1               = math.avg(conversionLine, baseLine)
leadLine2               = donchian(laggingSpan2Periods)

// Draw cloud
plot(conversionLine, color=#2962FF, title=&quot;Conversion Line&quot;, display=display.none)
plot(baseLine, color=#B71C1C, title=&quot;Base Line&quot;, display=display.none)
plot(close, offset = -displacement + 1, color=#43A047, title=&quot;Lagging Span&quot;, display=display.none)
p1 = plot(leadLine1, offset = displacement - 1, color=#A5D6A7, title=&quot;Leading Span A&quot;, display=display.none)
p2 = plot(leadLine2, offset = displacement - 1, color=#EF9A9A, title=&quot;Leading Span B&quot;, display=display.none)
fill(p1, p2, color = leadLine1 &gt; leadLine2 ? color.rgb(67, 160, 71, 90) : color.rgb(244, 67, 54, 90), display=display.none)

// Track horizontal baseline
var baseLineSaved = baseLine
if baseLine != baseLine[1]
    baseLineSaved := na
else
    baseLineSaved := baseLine

// Draw baseline
plot(baseLineSaved, color=color.purple, style=plot.style_linebr, title=&quot;Base Line Saved&quot;)

// Track price trading above/below baseline
isPriceAboveBaseLine = close &gt; baseLineSaved
priceTradingAboveBL = isPriceAboveBaseLine and not na(baseLineSaved)
priceTradingBelowBL = not isPriceAboveBaseLine and not na(baseLineSaved)

// Draw condition
bgcolor(priceTradingAboveBL ? color.new(color.green,80) : na)
bgcolor(priceTradingBelowBL ? color.new(color.red,80) : na)

// Track candle pattern tests of baseline (example purposes - needs more conditions to be actually useful!)
candlePatternBull = priceTradingAboveBL and priceTradingAboveBL[1] and low[1] &lt; baseLineSaved and close &gt; baseLineSaved
candlePatternBear = priceTradingBelowBL and priceTradingBelowBL[1] and high[1] &gt; baseLineSaved and close &lt; baseLineSaved
plotshape(candlePatternBull, style=shape.triangleup, color=color.green, location=location.belowbar)
plotshape(candlePatternBear, style=shape.triangledown, color=color.red)
</code></pre>
<h2 id="a-simple-pullback-strategy"><a class="header" href="#a-simple-pullback-strategy">A Simple Pullback Strategy</a></h2>
<p><a href="https://youtu.be/h-erJbnBj6A">Watch Lesson</a></p>
<pre><code class="language-python">// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © ZenAndTheArtOfTrading / www.PineScriptMastery.com
// @version=5
strategy(&quot;Simple Pullback Strategy&quot;, 
     overlay=true, 
     initial_capital=50000,
     default_qty_type=strategy.percent_of_equity, 
     default_qty_value=100, // 100% of balance invested on each trade
     commission_type=strategy.commission.percent, 
     commission_value=0.2)

// Get user input
i_ma1           = input.int(title=&quot;MA 1 Length&quot;, defval=120, step=10, group=&quot;Strategy Parameters&quot;, tooltip=&quot;Long-term MA&quot;)
i_ma2           = input.int(title=&quot;MA 2 Length&quot;, defval=10, step=10, group=&quot;Strategy Parameters&quot;, tooltip=&quot;Short-term MA&quot;)
i_stopPercent   = input.float(title=&quot;Stop Loss Percent&quot;, defval=0.10, step=0.1, group=&quot;Strategy Parameters&quot;, tooltip=&quot;Failsafe Stop Loss Percent Decline&quot;)
i_lowerClose    = input.bool(title=&quot;Exit On Lower Close&quot;, defval=false, group=&quot;Strategy Parameters&quot;, tooltip=&quot;Wait for a lower-close before exiting above MA2&quot;)
i_startTime     = input.time(title=&quot;Start Filter&quot;, defval=timestamp(&quot;01 Jan 1995 13:30 +0000&quot;), group=&quot;Time Filter&quot;, tooltip=&quot;Start date &amp; time to begin searching for setups&quot;)
i_endTime       = input.time(title=&quot;End Filter&quot;, defval=timestamp(&quot;1 Jan 2099 19:30 +0000&quot;), group=&quot;Time Filter&quot;, tooltip=&quot;End date &amp; time to stop searching for setups&quot;)

// Get indicator values
ma1 = ta.sma(close, i_ma1)
ma2 = ta.sma(close, i_ma2)

// Check filter(s)
f_dateFilter = time &gt;= i_startTime and time &lt;= i_endTime

// Check buy/sell conditions
var float buyPrice = 0
buyCondition    = close &gt; ma1 and close &lt; ma2 and strategy.position_size == 0 and f_dateFilter
sellCondition   = close &gt; ma2 and strategy.position_size &gt; 0 // (not i_lowerClose or close &lt; low[1])
stopDistance    = strategy.position_size &gt; 0 ? ((buyPrice - close) / close) : na
stopPrice       = strategy.position_size &gt; 0 ? buyPrice - (buyPrice * i_stopPercent) : na
stopCondition   = strategy.position_size &gt; 0 and stopDistance &gt; i_stopPercent

// Enter positions
if buyCondition
    strategy.entry(id=&quot;Long&quot;, direction=strategy.long)

if buyCondition[1]
    buyPrice := open

// Exit positions
if sellCondition or stopCondition
    strategy.close(id=&quot;Long&quot;, comment=&quot;Exit&quot; + (stopCondition ? &quot;SL=true&quot; : &quot;&quot;))
    buyPrice := na

// Draw pretty colors
plot(buyPrice, color=color.lime, style=plot.style_linebr)
plot(stopPrice, color=color.red, style=plot.style_linebr, offset=-1)
plot(ma1, color=color.blue)
plot(ma2, color=color.orange)
</code></pre>
<h2 id="macd-strategy--2-profit-targets"><a class="header" href="#macd-strategy--2-profit-targets">MACD Strategy + 2 Profit Targets</a></h2>
<p><a href="https://www.youtube.com/watch?v=P1Lol05qb5s">Watch Lesson</a></p>
<pre><code class="language-python">// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © ZenAndTheArtOfTrading / www.PineScriptMastery.com
//
// System Rules:
// Indicators: MACD indicator (default values), ATR (14), EMA (200)
// 1. Price must be trading above/below the 200 EMA
// 2. Only 1 bar can close above/below the 200 EMA over the past 5 bars
// 3. We take the FIRST MACD cross and ignore subsequent signals until TP/SL is hit
// 4. Stop Loss = 0.5 ATR above/below the recent swing high/low (7 bars lookback)
// 5. First take profit = 1:1 (25%)
// 6. Second take profit = 2:1 (100%)
// 7. Move stop loss to break-even after 1st target is hit
//
// @version=5
strategy(&quot;[2022] MACD Cross Strategy&quot;, overlay=true,
     currency=&quot;USD&quot;,
     calc_on_order_fills=true,
     use_bar_magnifier=true,
     initial_capital=10000,
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=100, // 100% of balance invested on each trade
     commission_type=strategy.commission.cash_per_contract)
     //commission_value=0.005) // Interactive Brokers rate

// Import ZenLibrary
import ZenAndTheArtOfTrading/ZenLibrary/5 as zen

// Get user input
var g_system    = &quot;System Entry Settings&quot;
i_ema_filter    = input.int(title=&quot;EMA Filter Length&quot;, defval=200, group=g_system)
i_ema_filter2   = input.int(title=&quot;EMA Max Bars Above/Below&quot;, defval=1, group=g_system)
i_stop_multi    = input.float(title=&quot;Stop Loss Multiplier&quot;, defval=0.5, step=0.5, group=g_system)
i_stop_lookback = input.int(title=&quot;Stop Loss Lookback&quot;, defval=7, group=g_system)
var g_risk      = &quot;System Risk Settings&quot;
i_rr1           = input.float(title=&quot;Risk:Reward Target 1&quot;, defval=1.0, group=g_risk)
i_rr2           = input.float(title=&quot;Risk:Reward Target 2&quot;, defval=2.0, group=g_risk)
i_target1       = input.float(title=&quot;Profit % Target 1&quot;, defval=25, group=g_risk)
i_riskPerTrade  = input.float(title=&quot;Forex Risk Per Trade %&quot;, defval=1.0)
var g_macd      = &quot;MACD Settings&quot;
i_price_src     = input.source(title=&quot;Price Source&quot;, defval=close, group=g_macd)
i_fast_length   = input.int(title=&quot;Fast Length&quot;, defval=12, group=g_macd)
i_slow_length   = input.int(title=&quot;Slow Length&quot;, defval=26, group=g_macd)
i_signal_length = input.int(title=&quot;Signal Smoothing&quot;, minval=1, maxval=50, defval=9, group=g_macd)
i_sma_source    = input.string(title=&quot;Oscillator MA Type&quot;, defval=&quot;EMA&quot;, options=[&quot;SMA&quot;, &quot;EMA&quot;], group=g_macd)
i_sma_signal    = input.string(title=&quot;Signal Line MA Type&quot;, defval=&quot;EMA&quot;, options=[&quot;SMA&quot;, &quot;EMA&quot;], group=g_macd)

//------------- DETERMINE CURRENCY CONVERSION RATE -------------//
// Check if our account currency is the same as the base or quote currency or neither (for risk $ conversion purposes)
accountSameAsCounterCurrency = strategy.account_currency == syminfo.currency
accountSameAsBaseCurrency = strategy.account_currency == syminfo.basecurrency
accountNeitherCurrency = not accountSameAsCounterCurrency and not accountSameAsBaseCurrency
// Get currency conversion rates if applicable
conversionCurrencyPair = accountSameAsCounterCurrency ? syminfo.tickerid : strategy.account_currency + syminfo.currency
conversionCurrencyRate = accountSameAsBaseCurrency or accountNeitherCurrency ? request.security(conversionCurrencyPair, &quot;D&quot;, close, ignore_invalid_symbol=true) : 1.0
// Display the current conversion currency ticker (for debug purposes)
if barstate.islastconfirmedhistory
    table t = table.new(position.top_right, 1, 2, color.black)
    table.cell(t, 0, 0, &quot;Conversion: &quot; + conversionCurrencyPair + &quot; (&quot; + str.tostring(conversionCurrencyRate) + &quot;)&quot;, text_color=color.white, text_size=size.small)
    table.cell(t, 0, 1, &quot;Account: $&quot; + str.tostring(zen.truncate(strategy.equity)), text_color=color.white, text_size=size.small)
//------------- END CURRENCY CONVERSION RATE CODE -------------//

// Calculate MACD
[macdLine, signalLine, histLine] = ta.macd(i_price_src, i_fast_length, i_slow_length, i_signal_length)

// Get indicator values
ema = ta.ema(close, i_ema_filter)
atr = ta.atr(14)

// Check for zero-point crosses
crossUp     = ta.crossover(signalLine, macdLine)
crossDown   = ta.crossunder(signalLine, macdLine)

// Check general system filters
tradeFilters = not na(ema) and not na(atr)

// Check trend conditions
upTrend     = close &gt; ema
downTrend   = close &lt; ema

// Check trade conditions
longConditions  = tradeFilters and macdLine[1] &lt; 0 and signalLine[1] &lt; 0
shortConditions = tradeFilters and macdLine[1] &gt; 0 and signalLine[1] &gt; 0

// Confirm long &amp; short setups
longSignal   = longConditions and upTrend and crossDown
shortSignal  = shortConditions and downTrend and crossUp

// Calculate stop loss
longStop    = ta.lowest(low, i_stop_lookback) - (atr * i_stop_multi)
shortStop   = ta.highest(high, i_stop_lookback) + (atr * i_stop_multi)

// Save stops &amp; targets
var float tradeStop = na
var float tradeTarget1 = na
var float tradeTarget2 = na
var float tradeSize = na

// Count bars above/below MA
int barsAboveMA = 0
int barsBelowMA = 0

for i = 1 to 5
    if close[i] &lt; ema[i]
        barsBelowMA += 1
    if close[i] &gt; ema[i]
        barsAboveMA += 1

// Combine signal filters
longTrade   = longSignal  and barsBelowMA &lt;= i_ema_filter2 and strategy.position_size == 0
shortTrade  = shortSignal and barsAboveMA &lt;= i_ema_filter2 and strategy.position_size == 0

// Handle long trade entry (enter position, reset stops &amp; targets)
if longTrade
    if syminfo.type == &quot;forex&quot;
        tradeStop := longStop
        stopDistance = close - tradeStop
        tradeTarget1 := close + (stopDistance * i_rr1)
        tradeTarget2 := close + (stopDistance * i_rr2)
        tradeSize := na
        positionSize = zen.av_getPositionSize(strategy.equity, i_riskPerTrade, zen.toWhole(stopDistance) * 10, conversionCurrencyRate)
        strategy.entry(id=&quot;Long&quot;, direction=strategy.long, qty=positionSize)
    else
        strategy.entry(id=&quot;Long&quot;, direction=strategy.long)
        tradeStop := na
        tradeTarget1 := na
        tradeTarget2 := na

// Handle short trade entry (enter position, reset stops &amp; targets)
if shortTrade
    if syminfo.type == &quot;forex&quot;
        tradeStop := shortStop
        stopDistance = tradeStop - close
        tradeTarget1 := close - (stopDistance * i_rr1)
        tradeTarget2 := close - (stopDistance * i_rr2)
        tradeSize := na
        positionSize = zen.av_getPositionSize(strategy.equity, i_riskPerTrade, zen.toWhole(shortStop - close) * 10, conversionCurrencyRate)
        strategy.entry(id=&quot;Short&quot;, direction=strategy.short, qty=positionSize)
    else
        strategy.entry(id=&quot;Short&quot;, direction=strategy.short)
        tradeStop := na
        tradeTarget1 := na
        tradeTarget2 := na
    
// Handle forex trade size tracking variable
if syminfo.type == &quot;forex&quot; and strategy.position_size != 0 and na(tradeSize)
    tradeSize := strategy.position_size

// Handle long stops &amp; target calculation
if strategy.position_size &gt; 0 and na(tradeStop) and syminfo.type != &quot;forex&quot;
    tradeStop := longStop
    stopDistance = strategy.position_avg_price - tradeStop
    tradeTarget1 := strategy.position_avg_price + (stopDistance * i_rr1)
    tradeTarget2 := strategy.position_avg_price + (stopDistance * i_rr2)
    tradeSize := strategy.position_size

// Handle short stops &amp; target calculation
if strategy.position_size &lt; 0 and na(tradeStop) and syminfo.type != &quot;forex&quot;
    tradeStop := shortStop
    stopDistance = tradeStop - strategy.position_avg_price
    tradeTarget1 := strategy.position_avg_price - (stopDistance * i_rr1)
    tradeTarget2 := strategy.position_avg_price - (stopDistance * i_rr2)
    tradeSize := strategy.position_size

// Handle trade exits
strategy.exit(id=&quot;Long Exit #1&quot;,  from_entry=&quot;Long&quot;,  limit=tradeTarget1, stop=tradeStop, qty_percent=i_target1)
strategy.exit(id=&quot;Long Exit #2&quot;,  from_entry=&quot;Long&quot;,  limit=tradeTarget2, stop=tradeStop, qty_percent=100)
strategy.exit(id=&quot;Short Exit #1&quot;, from_entry=&quot;Short&quot;, limit=tradeTarget1, stop=tradeStop, qty_percent=i_target1)
strategy.exit(id=&quot;Short Exit #2&quot;, from_entry=&quot;Short&quot;, limit=tradeTarget2, stop=tradeStop, qty_percent=100)

// Handle both long &amp; short trade break-even stops (do this AFTER first position has exited above ^)
if strategy.position_size != tradeSize
    tradeStop := strategy.position_avg_price
    tradeTarget1 := na

// Draw conditional data
plot(ema, color=close &gt; ema ? color.green : color.red, linewidth=2, title=&quot;EMA&quot;)
plotshape(longTrade,  style=shape.triangleup,   color=color.green, location=location.belowbar, title=&quot;Long Setup&quot;)
plotshape(shortTrade, style=shape.triangledown, color=color.red,   location=location.abovebar, title=&quot;Short Setup&quot;)

// Draw stops &amp; targets
plot(strategy.position_size != 0 ? tradeStop : na,   color=color.red,   style=plot.style_linebr, title=&quot;Stop Loss&quot;)
plot(strategy.position_size != 0 ? tradeTarget1 : na, color=color.green, style=plot.style_linebr, title=&quot;Profit Target 1&quot;)
plot(strategy.position_size != 0 ? tradeTarget2 : na, color=color.green, style=plot.style_linebr, title=&quot;Profit Target 2&quot;)
</code></pre>
<h2 id="calculating-forex-lot-sizes"><a class="header" href="#calculating-forex-lot-sizes">Calculating Forex LOT SIZES</a></h2>
<p><a href="https://youtu.be/Dp1C3oHrq7g">Watch Lesson</a></p>
<pre><code class="language-python">// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © ZenAndTheArtOfTrading / www.PineScriptMastery.com
//
// System Rules:
// Indicators: MACD indicator (default values), ATR (14), EMA (200)
// 1. Price must be trading above/below the 200 EMA
// 2. Only 1 bar can close above/below the 200 EMA over the past 5 bars
// 3. We take the FIRST MACD cross and ignore subsequent signals until TP/SL is hit
// 4. Stop Loss = 0.5 ATR above/below the recent swing high/low (7 bars lookback)
// 5. First take profit = 1:1 (25%)
// 6. Second take profit = 2:1 (100%)
// 7. Move stop loss to break-even after 1st target is hit
//
// @version=5
strategy(&quot;[2022] MACD Cross Strategy&quot;, overlay=true,
     currency=&quot;USD&quot;,
     calc_on_order_fills=true,
     use_bar_magnifier=true,
     initial_capital=10000,
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=100, // 100% of balance invested on each trade
     commission_type=strategy.commission.cash_per_contract)
     //commission_value=0.005) // Interactive Brokers rate

// Get user input
var g_system    = &quot;System Entry Settings&quot;
i_ema_filter    = input.int(title=&quot;EMA Filter Length&quot;, defval=200, group=g_system)
i_ema_filter2   = input.int(title=&quot;EMA Max Bars Above/Below&quot;, defval=1, group=g_system)
i_stop_multi    = input.float(title=&quot;Stop Loss Multiplier&quot;, defval=0.5, step=0.5, group=g_system)
i_stop_lookback = input.int(title=&quot;Stop Loss Lookback&quot;, defval=7, group=g_system)
var g_risk      = &quot;System Risk Settings&quot;
i_rr1           = input.float(title=&quot;Risk:Reward Target 1&quot;, defval=1.0, group=g_risk)
i_rr2           = input.float(title=&quot;Risk:Reward Target 2&quot;, defval=2.0, group=g_risk)
i_target1       = input.float(title=&quot;Profit % Target 1&quot;, defval=25, group=g_risk)
i_riskPerTrade  = input.float(title=&quot;Forex Risk Per Trade %&quot;, defval=1.0)
i_useLots       = input.bool(title=&quot;Use Lots Instead Of Units&quot;, defval=false)
var g_macd      = &quot;MACD Settings&quot;
i_price_src     = input.source(title=&quot;Price Source&quot;, defval=close, group=g_macd)
i_fast_length   = input.int(title=&quot;Fast Length&quot;, defval=12, group=g_macd)
i_slow_length   = input.int(title=&quot;Slow Length&quot;, defval=26, group=g_macd)
i_signal_length = input.int(title=&quot;Signal Smoothing&quot;, minval=1, maxval=50, defval=9, group=g_macd)
i_sma_source    = input.string(title=&quot;Oscillator MA Type&quot;, defval=&quot;EMA&quot;, options=[&quot;SMA&quot;, &quot;EMA&quot;], group=g_macd)
i_sma_signal    = input.string(title=&quot;Signal Line MA Type&quot;, defval=&quot;EMA&quot;, options=[&quot;SMA&quot;, &quot;EMA&quot;], group=g_macd)

//------------- DETERMINE CURRENCY CONVERSION RATE ------------- { //
// Import ZenLibrary
import ZenAndTheArtOfTrading/ZenLibrary/5 as zen
// Custom function for converting units into lot sizes
unitsToLots(units) =&gt;
    float lots = units / 100000
    lots := math.round(lots, 2)
    _return = lots * 100000
// Check if our account currency is the same as the base or quote currency or neither (for risk $ conversion purposes)
accountSameAsCounterCurrency = strategy.account_currency == syminfo.currency
accountSameAsBaseCurrency = strategy.account_currency == syminfo.basecurrency
accountNeitherCurrency = not accountSameAsCounterCurrency and not accountSameAsBaseCurrency
// Get currency conversion rates if applicable
conversionCurrencyPair = accountSameAsCounterCurrency ? syminfo.tickerid : strategy.account_currency + syminfo.currency
conversionCurrencyRate = accountSameAsBaseCurrency or accountNeitherCurrency ? request.security(conversionCurrencyPair, &quot;D&quot;, close, ignore_invalid_symbol=true) : 1.0
// Display the current conversion currency ticker (for debug purposes)
if barstate.islastconfirmedhistory
    table t = table.new(position.top_right, 1, 2, color.black)
    table.cell(t, 0, 0, &quot;Conversion: &quot; + conversionCurrencyPair + &quot; (&quot; + str.tostring(conversionCurrencyRate) + &quot;)&quot;, text_color=color.white, text_size=size.small)
    table.cell(t, 0, 1, &quot;Account: $&quot; + str.tostring(zen.truncate(strategy.equity)), text_color=color.white, text_size=size.small)
//------------- END CURRENCY CONVERSION RATE CODE ------------- }//

// Calculate MACD
[macdLine, signalLine, histLine] = ta.macd(i_price_src, i_fast_length, i_slow_length, i_signal_length)

// Get indicator values
ema = ta.ema(close, i_ema_filter)
atr = ta.atr(14)

// Check for zero-point crosses
crossUp     = ta.crossover(signalLine, macdLine)
crossDown   = ta.crossunder(signalLine, macdLine)

// Check general system filters
tradeFilters = not na(ema) and not na(atr)

// Check trend conditions
upTrend     = close &gt; ema
downTrend   = close &lt; ema

// Check trade conditions
longConditions  = tradeFilters and macdLine[1] &lt; 0 and signalLine[1] &lt; 0
shortConditions = tradeFilters and macdLine[1] &gt; 0 and signalLine[1] &gt; 0

// Confirm long &amp; short setups
longSignal   = longConditions and upTrend and crossDown
shortSignal  = shortConditions and downTrend and crossUp

// Calculate stop loss
longStop    = ta.lowest(low, i_stop_lookback) - (atr * i_stop_multi)
shortStop   = ta.highest(high, i_stop_lookback) + (atr * i_stop_multi)

// Save stops &amp; targets
var float tradeStop = na
var float tradeTarget1 = na
var float tradeTarget2 = na
var float tradeSize = na

// Count bars above/below MA
int barsAboveMA = 0
int barsBelowMA = 0

for i = 1 to 5
    if close[i] &lt; ema[i]
        barsBelowMA += 1
    if close[i] &gt; ema[i]
        barsAboveMA += 1

// Combine signal filters
longTrade   = longSignal  and barsBelowMA &lt;= i_ema_filter2 and strategy.position_size == 0
shortTrade  = shortSignal and barsAboveMA &lt;= i_ema_filter2 and strategy.position_size == 0

// Handle long trade entry (enter position, reset stops &amp; targets)
if longTrade
    if syminfo.type == &quot;forex&quot;
        tradeStop := longStop
        stopDistance = close - tradeStop
        tradeTarget1 := close + (stopDistance * i_rr1)
        tradeTarget2 := close + (stopDistance * i_rr2)
        tradeSize := na
        positionSize = zen.av_getPositionSize(strategy.equity, i_riskPerTrade, zen.toWhole(stopDistance) * 10, conversionCurrencyRate)
        strategy.entry(id=&quot;Long&quot;, direction=strategy.long, qty=i_useLots ? unitsToLots(positionSize) : positionSize)
    else
        strategy.entry(id=&quot;Long&quot;, direction=strategy.long)
        tradeStop := na
        tradeTarget1 := na
        tradeTarget2 := na

// Handle short trade entry (enter position, reset stops &amp; targets)
if shortTrade
    if syminfo.type == &quot;forex&quot;
        tradeStop := shortStop
        stopDistance = tradeStop - close
        tradeTarget1 := close - (stopDistance * i_rr1)
        tradeTarget2 := close - (stopDistance * i_rr2)
        tradeSize := na
        positionSize = zen.av_getPositionSize(strategy.equity, i_riskPerTrade, zen.toWhole(shortStop - close) * 10, conversionCurrencyRate)
        strategy.entry(id=&quot;Short&quot;, direction=strategy.short, qty=i_useLots ? unitsToLots(positionSize) : positionSize)
    else
        strategy.entry(id=&quot;Short&quot;, direction=strategy.short)
        tradeStop := na
        tradeTarget1 := na
        tradeTarget2 := na
    
// Handle forex trade size tracking variable
if syminfo.type == &quot;forex&quot; and strategy.position_size != 0 and na(tradeSize)
    tradeSize := strategy.position_size

// Handle long stops &amp; target calculation
if strategy.position_size &gt; 0 and na(tradeStop) and syminfo.type != &quot;forex&quot;
    tradeStop := longStop
    stopDistance = strategy.position_avg_price - tradeStop
    tradeTarget1 := strategy.position_avg_price + (stopDistance * i_rr1)
    tradeTarget2 := strategy.position_avg_price + (stopDistance * i_rr2)
    tradeSize := strategy.position_size

// Handle short stops &amp; target calculation
if strategy.position_size &lt; 0 and na(tradeStop) and syminfo.type != &quot;forex&quot;
    tradeStop := shortStop
    stopDistance = tradeStop - strategy.position_avg_price
    tradeTarget1 := strategy.position_avg_price - (stopDistance * i_rr1)
    tradeTarget2 := strategy.position_avg_price - (stopDistance * i_rr2)
    tradeSize := strategy.position_size

// Handle trade exits
float exitPartialUnits = math.abs(strategy.position_size / (100 / i_target1))
float exitPartialLots = unitsToLots(exitPartialUnits)
strategy.exit(id=&quot;Long Exit #1&quot;,  from_entry=&quot;Long&quot;,  limit=tradeTarget1, stop=tradeStop, qty=i_useLots ? exitPartialLots : exitPartialUnits)
strategy.exit(id=&quot;Long Exit #2&quot;,  from_entry=&quot;Long&quot;,  limit=tradeTarget2, stop=tradeStop, qty_percent=100)
strategy.exit(id=&quot;Short Exit #1&quot;, from_entry=&quot;Short&quot;, limit=tradeTarget1, stop=tradeStop, qty=i_useLots ? exitPartialLots : exitPartialUnits)
strategy.exit(id=&quot;Short Exit #2&quot;, from_entry=&quot;Short&quot;, limit=tradeTarget2, stop=tradeStop, qty_percent=100)

// Handle both long &amp; short trade break-even stops (do this AFTER first position has exited above ^)
if strategy.position_size != tradeSize
    tradeStop := strategy.position_avg_price
    tradeTarget1 := na

// Draw conditional data
plot(ema, color=close &gt; ema ? color.green : color.red, linewidth=2, title=&quot;EMA&quot;)
plotshape(longTrade,  style=shape.triangleup,   color=color.green, location=location.belowbar, title=&quot;Long Setup&quot;)
plotshape(shortTrade, style=shape.triangledown, color=color.red,   location=location.abovebar, title=&quot;Short Setup&quot;)

// Draw stops &amp; targets
plot(strategy.position_size != 0 ? tradeStop : na,   color=color.red,   style=plot.style_linebr, title=&quot;Stop Loss&quot;)
plot(strategy.position_size != 0 ? tradeTarget1 : na, color=color.green, style=plot.style_linebr, title=&quot;Profit Target 1&quot;)
plot(strategy.position_size != 0 ? tradeTarget2 : na, color=color.green, style=plot.style_linebr, title=&quot;Profit Target 2&quot;)
</code></pre>
<h2 id="mean-reversion-strategy"><a class="header" href="#mean-reversion-strategy">Mean Reversion Strategy</a></h2>
<p><a href="https://youtu.be/yz_T1gpAw6Y">Watch Lesson</a></p>
<pre><code class="language-python">// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © ZenAndTheArtOfTrading / www.PineScriptMastery.com
// @version=5
strategy(&quot;ATR Reversion System&quot;, 
     overlay=true, 
     currency=currency.USD,
     initial_capital=100000, 
     default_qty_type=strategy.percent_of_equity, 
     default_qty_value=100, 
     commission_type=strategy.commission.cash_per_order, 
     commission_value=9.95)

// Get user input
i_EmaLongLength     = input.int(title=&quot;Long-term EMA&quot;, defval=200)
i_EmaShortLength    = input.int(title=&quot;Short-term EMA Length&quot;, defval=20)
i_ATRPeriod         = input.int(title=&quot;ATR Period&quot;, defval=5)
i_ATRBand           = input.float(title=&quot;ATR Band Distance&quot;, defval=1)
i_ATRStretch        = input.float(title=&quot;ATR Buy Stretch&quot;, defval=1)
i_SellBand          = input.string(title=&quot;Sell At Band:&quot;, defval=&quot;Middle&quot;, options=[&quot;Top&quot;, &quot;Middle&quot;, &quot;Bottom&quot;])
i_SellSrc           = input.source(title=&quot;Sell Price Source&quot;, defval=high)

// Get indicator values
emaLongTerm     = ta.ema(close, i_EmaLongLength)
emaShortTerm    = ta.ema(close, i_EmaShortLength)
atrValue        = ta.atr(i_ATRPeriod)

// Get ATR bands
atrBandTop = emaShortTerm + (atrValue * i_ATRBand)
atrBandBot = emaShortTerm - (atrValue * i_ATRBand)

// Define price stretch
float buyLimitPrice = na

// Check setup conditions = bar close is below ATR band, above long-term EMA
setupCondition = close &lt; atrBandBot and low &gt; emaLongTerm

// Clear any pending limit orders
strategy.cancel_all()

// Enter trades on next bar after setup condition is met
if setupCondition
    buyLimitPrice := low - (atrValue * i_ATRStretch)
    strategy.entry(&quot;Long&quot;, strategy.long, limit=buyLimitPrice)

// Get sell price
sellPrice = switch i_SellBand
    &quot;Top&quot;       =&gt; atrBandTop
    &quot;Middle&quot;    =&gt; emaShortTerm
    &quot;Bottom&quot;    =&gt; atrBandBot

// Exit trades
if i_SellSrc &gt;= sellPrice or close &lt; emaLongTerm
    strategy.close(&quot;Long&quot;, comment=&quot;Exit trade&quot;)

// Draw data to chart
plot(emaLongTerm, &quot;EMA Filter&quot;, color.red, 2)
plot(emaShortTerm, &quot;ATR Band Middle&quot;, color.blue)
plot(atrBandBot, &quot;ATR Band Bottom&quot;, color=color.green)
plot(atrBandTop, &quot;ATR Band Top&quot;, color=color.new(color.gray, 75))
plot(setupCondition ? buyLimitPrice : na, &quot;Buy Limit&quot;, color.lime, 1, plot.style_cross)
</code></pre>

                        <script src="https://utteranc.es/client.js"
                            repo="imxood/imxood.github.io"
                            issue-term="pathname"
                            theme="boxy-light"
                            crossorigin="anonymous"
                            async>
                        </script>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../strategy/grid.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../strategy/阿老師.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../strategy/grid.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../strategy/阿老師.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_line_numbers = true;
        </script>
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../theme/custom/mermaid.min.js"></script>
        <script type="text/javascript" src="../theme/custom/mermaid-init.js"></script>
    </body>
</html>
