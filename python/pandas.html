<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Pandas - Jason Notes</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/custom/custom.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html">Jason Notes</a></li><li class="chapter-item expanded "><a href="../ubuntu/ubuntu_setup.html">Ubuntu</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../ubuntu/command.html">Command</a></li><li class="chapter-item "><a href="../ubuntu/gcp.html">GCP ssh</a></li></ol></li><li class="chapter-item expanded "><a href="../android/android.html">Android</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../android/install_sdk.html">SDK install</a></li></ol></li><li class="chapter-item expanded "><a href="../tools/tools.html">Tools</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../tools/asciinema.html">asciinema 把終端操作錄製成 gif 動畫</a></li><li class="chapter-item "><a href="../tools/finmind.html">Finmind</a></li><li class="chapter-item "><a href="../tools/add-enter-and-exit-trace-for-your-function.html">addr2line</a></li><li class="chapter-item "><a href="../tools/cmake.html">cmake</a></li><li class="chapter-item "><a href="../tools/network.html">Network</a></li><li class="chapter-item "><a href="../tools/python-pycryptodome-aes-symmetric-encryption-tutorial-examples.html">實作 AES 對稱式加密</a></li></ol></li><li class="chapter-item expanded "><a href="../html/html.html">HTML</a></li><li class="chapter-item expanded "><a href="../vim/vim.html">Vim</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../vim/copilot.html">copilot</a></li><li class="chapter-item "><a href="../vim/tabnine.html">tabnine</a></li></ol></li><li class="chapter-item expanded "><a href="../gdb/gdb.html">Gdb</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../gdb/常用指令.html">常用指令</a></li><li class="chapter-item "><a href="../gdb/jemalloc.html">jemalloc</a></li><li class="chapter-item "><a href="../gdb/graphs.html">graphs</a></li><li class="chapter-item "><a href="../gdb/rust-gdb.html">rust gdb</a></li></ol></li><li class="chapter-item expanded "><a href="../c++/cpp.html">C++</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../c++/benchmark.html">benchmark</a></li><li class="chapter-item "><a href="../c++/smart_pointer.html">Smart pointer</a></li><li class="chapter-item "><a href="../c++/l&rvalue.html">L&amp;R value</a></li><li class="chapter-item "><a href="../c++/move.html">Move</a></li><li class="chapter-item "><a href="../c++/CAS.html">CAS</a></li><li class="chapter-item "><a href="../c++/HFT.html">HFT</a></li></ol></li><li class="chapter-item expanded "><a href="../riscv/riscv.html">RISC-V</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../riscv/qemu_riscv_linux.html">QEMU上運行RISV-V Linux</a></li></ol></li><li class="chapter-item expanded "><a href="../centos/centos.html">CentOS</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../centos/tqdb_setup.html">TQDB 安裝紀錄</a></li></ol></li><li class="chapter-item expanded "><a href="../ssh/ssh.html">SSH</a></li><li class="chapter-item expanded "><a href="../network/socket.html">Network</a></li><li class="chapter-item expanded "><a href="../docker/docker_helloworld.html">Docker</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../docker/docker.html">Docker 基本教學</a></li><li class="chapter-item "><a href="../docker/example.html">簡單範例</a></li><li class="chapter-item "><a href="../docker/creating-the-perfect-python-dockerfile.html">Perfect python dockerfile</a></li><li class="chapter-item "><a href="../docker/dockerfile-from-docker-image.html">由 Docker image 反推其 Dockerfile</a></li><li class="chapter-item "><a href="../docker/python_connect_redis.html">Python連接Redis</a></li><li class="chapter-item "><a href="../docker/command.html">Command</a></li><li class="chapter-item "><a href="../docker/docker_compose.html">Docker compose</a></li><li class="chapter-item "><a href="../docker/docker_compse_example.html">Docker compose example</a></li><li class="chapter-item "><a href="../docker/python_redis.html">Python-Redis</a></li><li class="chapter-item "><a href="../docker/redash.html">Redash</a></li><li class="chapter-item "><a href="../docker/clickhouse.html">ClickHouse</a></li><li class="chapter-item "><a href="../docker/clickhouse-setup.html">clickhouse-setup</a></li></ol></li><li class="chapter-item expanded "><a href="../rust/rust.html">Rust</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../rust/note.html">Rust筆記</a></li><li class="chapter-item "><a href="../rust/basic.html">Rust 基本教學</a></li><li class="chapter-item "><a href="../rust/ownership.html">Rust 所有權系統</a></li><li class="chapter-item "><a href="../rust/lifetime.html">Rust 生命週期 (Lifetime)</a></li><li class="chapter-item "><a href="../rust/type.html">Rust 型別系統</a></li><li class="chapter-item "><a href="../rust/polars.html">Polars</a></li><li class="chapter-item "><a href="../rust/rust_call_c.html">Rust call C</a></li><li class="chapter-item "><a href="../rust/10-rust-an-introduction.html">給 C++ 使用者的 Rust 簡介</a></li><li class="chapter-item "><a href="../rust/可視化Rust各資料結構的記憶體佈局.html">可視化Rust各資料結構的記憶體佈局</a></li><li class="chapter-item "><a href="../rust/rust_note.html">學習順序</a></li><li class="chapter-item "><a href="../rust/overview.html">大局觀</a></li><li class="chapter-item "><a href="../rust/String.html">理解字串</a></li><li class="chapter-item "><a href="../rust/easy_rust.html">Easy Rust</a></li><li class="chapter-item "><a href="../rust/rust_easy.html">Rust 新手</a></li><li class="chapter-item "><a href="../rust/module.html">Rust 模組結構</a></li><li class="chapter-item "><a href="../rust/rust_memory.html">Rust與記憶體</a></li><li class="chapter-item "><a href="../rust/rust_vs_cpp.html">Rust vs C++語法</a></li><li class="chapter-item "><a href="../rust/rust_file_format.html">Rust 檔案格式</a></li><li class="chapter-item "><a href="../rust/binary_lib.html">Rust 函數庫/執行檔</a></li><li class="chapter-item "><a href="../rust/print-function-name-dump-stack.html">印出函數名稱</a></li><li class="chapter-item "><a href="../rust/note.html">30天深入淺出Rust系列</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../rust/30天深入淺出Rust系列/rust_30_day.html">Rust 30 Day</a></li><li class="chapter-item "><a href="../rust/30天深入淺出Rust系列/Move_Borrow_Ownership.html">變數的所有權與借出變數</a></li><li class="chapter-item "><a href="../rust/30天深入淺出Rust系列/Lifetime.html">Lifetime： Borrow 的存活時間</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../go/go.html">Go</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../go/note.html">Golang  Note</a></li><li class="chapter-item "><a href="../go/pytago.html">pytago</a></li><li class="chapter-item "><a href="../go/Go編程實戰派基礎入門.html">Go編程實戰派基礎入門</a></li><li class="chapter-item "><a href="../go/Go編程實戰派Web開發基礎.html">Go編程實戰派Web開發基礎</a></li><li class="chapter-item "><a href="../go/golang_debugger.html">Golang Deubgger</a></li><li class="chapter-item "><a href="../go/golang-go-module-tutorial.html">從一知半解到略懂 Go modules</a></li><li class="chapter-item "><a href="../go/go_mod.html">Go modules</a></li><li class="chapter-item "><a href="../go/trace.html">Golang大殺器之跟蹤剖析trace</a></li><li class="chapter-item "><a href="../go/Coroutine.html">行程、執行緒、協程，傻傻分得清楚！</a></li><li class="chapter-item "><a href="../go/goroutine-and-channel.html">Go併發</a></li><li class="chapter-item "><a href="../go/websocket.html">Websocket</a></li><li class="chapter-item "><a href="../go/returning-pointer-from-a-function-in-go.html">Returning Pointer from a Function in Go</a></li><li class="chapter-item "><a href="../go/golang-memory-management.html">GC 全面解析</a></li><li class="chapter-item "><a href="../go/golang-goroutine.html">Goroutine 與 GMP 原理全面分析</a></li><li class="chapter-item "><a href="../go/oo.html">OO</a></li><li class="chapter-item "><a href="../go/mutex-rwmutex.html">sync.Mutex 和 sync.RWMutex</a></li><li class="chapter-item "><a href="../go/interface.html">interface</a></li><li class="chapter-item "><a href="../go/example.html">Example</a></li></ol></li><li class="chapter-item expanded "><a href="../ml/ml.html">ML</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../ml/pytorch.html">Pytorch</a></li></ol></li><li class="chapter-item expanded "><a href="../python/python.html">Python</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../python/Poetry完全入門指南.html">Poetry完全入門指南</a></li><li class="chapter-item "><a href="../python/搭建gRPC服務.html">搭建gRPC服務</a></li><li class="chapter-item "><a href="../python/python_debugger.html">Python Debugger</a></li><li class="chapter-item "><a href="../python/decorator.html">Python decorator</a></li><li class="chapter-item "><a href="../python/python-decorator.html">裝飾器看這一篇就夠了</a></li><li class="chapter-item "><a href="../python/import-concept.html">import-concept</a></li><li class="chapter-item "><a href="../python/process_thread.html">Process/Thread優缺點</a></li><li class="chapter-item "><a href="../python/processing_communcation.html">Processing 通訊</a></li><li class="chapter-item "><a href="../python/condition.html">Python中的wait和notify</a></li><li class="chapter-item "><a href="../python/生產者消費者模式.html">生產者消費者模式</a></li><li class="chapter-item "><a href="../python/Loguru.html">Loguru</a></li><li class="chapter-item "><a href="../python/WebSocket_reconnect.html">Python WebSocket長連接心跳與短連接</a></li><li class="chapter-item "><a href="../python/bloomrpc.html">bloomrpc</a></li><li class="chapter-item "><a href="../python/concurrent.futures.html">Concurrent futures</a></li><li class="chapter-item "><a href="../python/schedule.html">任務調度</a></li><li class="chapter-item "><a href="../python/plot/plot.html">Plot</a></li><li class="chapter-item "><a href="../python/plot/dash.html">Dash</a></li><li class="chapter-item "><a href="../python/Rust_bindings_for_Python.html">Rust bindings for Python</a></li><li class="chapter-item expanded "><a href="../python/pandas.html" class="active">Pandas</a></li><li class="chapter-item "><a href="../python/coroutine.html">Coroutine</a></li><li class="chapter-item "><a href="../python/finmind.html">FinMind</a></li><li class="chapter-item "><a href="../python/telegram_bot.html">Telegram Bot</a></li><li class="chapter-item "><a href="../python/websocket_client_server.html">Websocket client/server</a></li><li class="chapter-item "><a href="../python/poetry.html">從零開始使用 Poetry</a></li><li class="chapter-item "><a href="../python/fil-memory-usage-profiler.html">Fil-memory-usage-profiler</a></li><li class="chapter-item "><a href="../python/plot.html">繪圖</a></li><li class="chapter-item "><a href="../python/shioaji.html">永豐shioaji</a></li><li class="chapter-item "><a href="../python/other.html">Other</a></li></ol></li><li class="chapter-item expanded "><a href="../mermaid/mermaid.html">Mermaid</a></li><li class="chapter-item expanded "><a href="../linux_system/perf.html">Linux System</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../linux_system/1_day_socket.html">Socket</a></li><li class="chapter-item "><a href="../linux_system/cgroup.html">Cgroup</a></li><li class="chapter-item "><a href="../linux_system/perf.html">Perf</a></li></ol></li><li class="chapter-item expanded "><a href="../strategy/bollmaker.html">Strategy</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../strategy/造市/market_market.html">造市</a></li><li class="chapter-item "><a href="../strategy/tw_futures.html">臺指</a></li><li class="chapter-item "><a href="../strategy/arbitrage.html">套利</a></li><li class="chapter-item "><a href="../strategy/海龜交易.html">海龜交易</a></li><li class="chapter-item "><a href="../strategy/如何避免過擬合.html">如何避免過擬合</a></li><li class="chapter-item "><a href="../strategy/Option/option.html">選擇權</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../strategy/Option/option_note.html">Option note</a></li></ol></li><li class="chapter-item "><a href="../strategy/vectorbt.html">VectorBT</a></li><li class="chapter-item "><a href="../strategy/orderbook.html">Orderbook</a></li><li class="chapter-item "><a href="../strategy/選股條件.html">選股條件</a></li><li class="chapter-item "><a href="../strategy/如何出場.html">如何出場</a></li><li class="chapter-item "><a href="../strategy/Book/JG.html">JG</a></li><li class="chapter-item "><a href="../strategy/bnf.html">BNF</a></li><li class="chapter-item "><a href="../strategy/stock.html">Stock</a></li><li class="chapter-item "><a href="../strategy/note.html">Resource</a></li><li class="chapter-item "><a href="../strategy/nansen.html">Nansen</a></li><li class="chapter-item "><a href="../strategy/example.html">Example</a></li><li class="chapter-item "><a href="../strategy/other.html">Other</a></li><li class="chapter-item "><a href="../strategy/sample.html">Sample</a></li><li class="chapter-item "><a href="../strategy/grid.html">Grid</a></li><li class="chapter-item "><a href="../strategy/pine-script.html">pine-script</a></li><li class="chapter-item "><a href="../strategy/sharpe_ratio.html">夏普值</a></li><li class="chapter-item "><a href="../strategy/display_mae_mfe_analysis.html">MAE&amp;MFE分析</a></li><li class="chapter-item "><a href="../strategy/海龜投資法則.html">海龜投資法則</a></li><li class="chapter-item "><a href="../strategy/edge-ratio-follow-application.html">彈性進出場的判斷</a></li><li class="chapter-item "><a href="../strategy/finlab.html">Finlab</a></li><li class="chapter-item "><a href="../strategy/backtrader/basis.html">Backtrader</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../strategy/backtrader/Python回測框架一Backtrader介紹.html">Python回測框架一Backtrader介紹</a></li><li class="chapter-item "><a href="../strategy/backtrader/Python回測框架二定期定額投資.html">Python 回測框架（二）定期定額投資</a></li><li class="chapter-item "><a href="../strategy/backtrader/Python回測框架三技術指標.html">Python 回測框架（三）技術指標</a></li><li class="chapter-item "><a href="../strategy/backtrader/Python回測框架四CrossOver和Signal.html">Python 回測框架（四）CrossOver 和 Signal</a></li><li class="chapter-item "><a href="../strategy/backtrader/Python回測框架五Sizer.html">Python 回測框架（五）Sizer</a></li><li class="chapter-item "><a href="../strategy/backtrader/Python回測框架六Analyzers.html">Python 回測框架（六）Analyzers</a></li><li class="chapter-item "><a href="../strategy/backtrader/多股組合操作策略.html">多股組合操作</a></li><li class="chapter-item "><a href="../strategy/backtrader/均線交叉策略.html">均線交叉策略</a></li><li class="chapter-item "><a href="../strategy/backtrader/唐奇安通道策略.html">唐奇安通道策略</a></li><li class="chapter-item "><a href="../strategy/backtrader/Sizers模組.html">Sizers模組</a></li><li class="chapter-item "><a href="../strategy/backtrader/Observers模組.html">Observers模組</a></li><li class="chapter-item "><a href="../strategy/backtrader/Pyfolio.html">Pyfolio</a></li><li class="chapter-item "><a href="../strategy/backtrader/Sample.html">Sample</a></li><li class="chapter-item "><a href="../strategy/backtrader/performance.html">Performance</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../mq/kafka.html">MQ</a></li><li class="chapter-item expanded "><a href="../mq/kafka-python.html">Kafka的通俗總結</a></li><li class="chapter-item expanded "><a href="../database/redis.html">Database</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../database/redis.html">Redis</a></li><li class="chapter-item "><a href="../database/hash.html">Redis Hash</a></li><li class="chapter-item "><a href="../database/clickhouse.html">ClickHouse</a></li><li class="chapter-item "><a href="../database/dolphin.html">Dolphin</a></li><li class="chapter-item "><a href="../database/sqlite.html">Sqlite</a></li></ol></li><li class="chapter-item expanded "><a href="../cryptotrade/cryptotrade.html">CryptoTrade</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../cryptotrade/binance/binance.html">Binance</a></li><li class="chapter-item "><a href="../cryptotrade/binance/oco.html">如何將OCO訂單發送到Binance</a></li></ol></li><li class="chapter-item expanded "><a href="../git/git.html">Git</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../git/git-remove-commited-files.html">git-remove-commited-files</a></li><li class="chapter-item "><a href="../git/cheat-sheet.html">Git 常用</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="dataframe-成-pickle-後寫入-redis-之後取出在-unpickle"><a class="header" href="#dataframe-成-pickle-後寫入-redis-之後取出在-unpickle">dataframe 成 pickle 後寫入 redis, 之後取出在 unpickle</a></h2>
<pre><code class="language-python">from finlab import data
import redis
import pickle

# Connect to Redis
r = redis.Redis(host='localhost', port=6379, db=11)

# Get the data and save it to Redis
營業利益成長率 = data.get(&quot;price:收盤價&quot;)
r.set('test', pickle.dumps(營業利益成長率))
with open('test.bin', 'wb') as f:
    pickle.dump(營業利益成長率, f)


with open('test.bin', 'rb') as f:
    new_dict = pickle.load(f)
    print(new_dict)

# Read the data from Redis and unpickle it
unpickled_df = pickle.loads(r.get('test'))

print(unpickled_df)

with open('gg.bin', 'wb') as f:
    pickle.dump(pickle.loads(r.get('test')) , f)

with open('gg.bin', 'rb') as f:
    new_dict = pickle.load(f)
    print(new_dict)
</code></pre>
<h2 id="對一個欄位nan-使用-bfill"><a class="header" href="#對一個欄位nan-使用-bfill">對一個欄位nan 使用 bfill</a></h2>
<pre><code class="language-python">import pandas as pd
import numpy as np

# 建立範例 DataFrame
df = pd.DataFrame({'A': [1, 2, 3, np.nan, np.nan, 6, np.nan, 8]})

# 針對欄位 A 使用 backfill 填充 NaN 值
df['A'] = df['A'].fillna(method='backfill')

# 印出填充後的 DataFrame
print(df)
</code></pre>
<h2 id="兩個不同大小df-使用-fillna-方法使用後向填充法填充缺失值"><a class="header" href="#兩個不同大小df-使用-fillna-方法使用後向填充法填充缺失值">兩個不同大小DF 使用 fillna() 方法使用後向填充法填充缺失值</a></h2>
<pre><code class="language-python">import pandas as pd

# 創建第一個 dataframe
df1 = pd.DataFrame({'IsTrue': [False]},
                   index=pd.to_datetime(['2023-02-28']))

# 創建第二個 dataframe
df2 = pd.DataFrame({'close': [239.0, 241.0, 247.0, 227.5, 231.0]},
                   index=pd.to_datetime(['2023-02-17', '2023-02-20', '2023-02-21', '2023-02-22', '2023-02-23']))

# 將第一個 dataframe 轉換為一列 dataframe，然後與第二個 dataframe 進行合併
df = pd.concat([df2, df1], axis=1)  # 使用 pd.concat() 方法將兩個 dataframe 合併
df.fillna(method='bfill', inplace=True)  # 使用 bfill 方法填充缺失值
df.dropna(how=&quot;any&quot;, inplace=True)  # 使用 dropna 方法刪除仍存在的 NaN 值

print(df)
</code></pre>
<h2 id="的-concat-函數將兩個-dataframe-以-df1-為主然後指定-axis1-將-df2-以欄位的方式合併至-df1"><a class="header" href="#的-concat-函數將兩個-dataframe-以-df1-為主然後指定-axis1-將-df2-以欄位的方式合併至-df1">的 <code>concat</code> 函數將兩個 DataFrame 以 df1 為主，然後指定 <code>axis=1</code> 將 df2 以欄位的方式合併至 df1</a></h2>
<pre><code class="language-python">import pandas as pd

# 創建 True/False 值 DataFrame
df1 = pd.DataFrame({'is_buy': [True, False, True, False]}, 
                   index=pd.to_datetime(['2022-01-01', '2022-01-02', '2022-01-03', '2022-01-04']))

# 創建均價 DataFrame（日期為 2022-01-01 和 2022-01-03）
df2 = pd.DataFrame({'mean_price': [100, 300]}, 
                   index=pd.to_datetime(['2022-01-01', '2022-01-03']))

# 將 df1 和 df2 以欄位的方式合併
df_merged = pd.concat([df1, df2.reindex(df1.index)], axis=1)

# 刪除含有 NaN 值的列
df_merged = df_merged.dropna(how='any')

print(df_merged)

</code></pre>
<p><a href="https://ds.apachecn.org/#/">資料科學與分析譯文集</a></p>
<pre><code class="language-python">pd.options.display.float_format = lambda x: &quot;%.2f&quot; % x
</code></pre>
<h2 id="python量化交易實戰之使用resample函數轉換日k數據"><a class="header" href="#python量化交易實戰之使用resample函數轉換日k數據">Python量化交易實戰之使用Resample函數轉換“日K”數據</a></h2>
<p>https://walkonnet.com/archives/138620</p>
<p>使用Resample函數轉換時間序列</p>
<h2 id="一什麼是resample函數"><a class="header" href="#一什麼是resample函數">一、什麼是resample函數？</a></h2>
<p>它是Python數據分析庫Pandas的方法函數。</p>
<p>它主要用於轉換時間序列的頻次。可以做一些統計匯總的工作。</p>
<p>什麼叫轉換時間序列的頻次呢？</p>
<p>比如說股票的日k和周k，</p>
<p>假設我隻能獲取到股票日K的數據，比如說11月1號到11月5號，那怎麼樣將它轉換為以周為單位的K線呢？</p>
<table><thead><tr><th>日期</th><th>週期</th><th>開盤價</th><th>收盤價</th><th>最高價</th><th>最低價</th></tr></thead><tbody>
<tr><td>11月1號</td><td>週一</td><td>1.11</td><td>1.11</td><td>1.11</td><td>1.12</td></tr>
<tr><td>11月2號</td><td>週二</td><td>1.12</td><td>1.12</td><td>1.11</td><td>1.12</td></tr>
<tr><td>11月3號</td><td>週三</td><td>1.13</td><td>1.13</td><td>1.11</td><td>1.12</td></tr>
<tr><td>11月4號</td><td>週四</td><td>1.15</td><td>1.14</td><td>1.11</td><td>1.12</td></tr>
<tr><td>11月5號</td><td>週五</td><td>1.14</td><td>1.15</td><td>1.11</td><td>1.12</td></tr>
</tbody></table>
<p>首先我們要明確，周K的開盤、收盤、最高、最低是什麼。每週的開盤價是當周第一天的開盤價，收盤價是當周最後一天的收盤價，它的最高價是這周最高的價格，最低價是本週所有最低價中最低的價格。所以你去看炒股平臺，它的周k都是以週五的交易日為記錄的時間點位置。開盤、收盤、最高、最低是按照我剛剛講解的這個規則來計算的。至於月K、年K的選取規則也是一樣的。月K的週期是一個月，年K的週期是一年。</p>
<p>這個計算準確性你也可以通過網上的數據進行驗證。這個計算規則，包括開盤、收盤、最高、最低的計算，收拾resample函數可以做到的事情。此外Resample還有個功能，就是做統計匯總，比如說我想計算一支股票總的周成交量，就可以使用Resample.sum函數去把週一到週五的成交量加起來。</p>
<p>為瞭方便大傢記憶 ，你也可以把resample理解為Excel表格中的透視表功能。你可以按照日期做各種篩選和匯總統計的。最重要的是他可以按照日期。</p>
<h2 id="二實戰resample函數"><a class="header" href="#二實戰resample函數">二、實戰Resample函數</a></h2>
<p>因為這2節課還是一些比較基礎的部分，所以還沒有做模塊化的內容。</p>
<p>我們會在創建股票數據庫的時候 來做真正的模塊化的工作。到這裡都是初級的腳本的形式。先提前說下。</p>
<h3 id="1日k-轉換為-周k"><a class="header" href="#1日k-轉換為-周k">1.日K 轉換為 周K</a></h3>
<p>1.1函數文檔學習</p>
<p>谷歌搜索<code>Pandas Resample</code>：第一個鏈接就是這個函數的官方文檔</p>
<p>https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.resample.html</p>
<p>這裡有介紹：Resample是屬於Pandas DataFrame下面的方法。這裡有關於參數的解釋。</p>
<p>這裡我們隻對2個常用參數講解，一個是rule，另一個是closed。</p>
<ul>
<li>rule表示的是你放一個什麼樣的週期性指標在裡面，用m代表Month，Y代表Year,w代表Week，</li>
<li>closed代表你取哪一個分界線，舉例來說，比如說我把日k轉換為周k，到底我是取週一為分界線還是週五為分界線呢？這就是通過closed來確定的。</li>
</ul>
<p>這裡有它的例子：</p>
<pre><code class="language-python">&gt;&gt;&gt;index = pd.date_range('1/1/2000', periods=9, freq='T')
&gt;&gt;&gt;series = pd.Series(range(9), index=index)
&gt;&gt;&gt;series
2000-01-01 00:00:00    0
2000-01-01 00:01:00    1
2000-01-01 00:02:00    2
2000-01-01 00:03:00    3
2000-01-01 00:04:00    4
2000-01-01 00:05:00    5
2000-01-01 00:06:00    6
2000-01-01 00:07:00    7
2000-01-01 00:08:00    8
Freq: T, dtype: int64
</code></pre>
<p>這裡首先創建瞭一個時間序列的<code>DataFrame</code>，就是這個<code>series</code>變量。你可以理解為它是一個隻有一個字段的表格樣式。接著往下看：</p>
<pre><code class="language-python">&gt;&gt;&gt;series.resample('3T').sum()
2000-01-01 00:00:00     3
2000-01-01 00:03:00    12
2000-01-01 00:06:00    21
Freq: 3T, dtype: int64
</code></pre>
<p>這裡使用瞭<code>Resample</code>方法，<code>3T</code>就是3分鐘，<code>T</code>表示分鐘。<code>sum()</code>就是匯總，也就是針對這一列數據進行匯總。</p>
<p>也就是說，每3分鐘統計依次。註意到，這個時間序列匯總的時間取的值是3分鐘的第一分鐘。如果我想取時間週期的最後一分鐘，可以將label的值改為“right”：</p>
<pre><code class="language-python">&gt;&gt;&gt;series.resample('3T', label='right').sum()
2000-01-01 00:03:00     3
2000-01-01 00:06:00    12
2000-01-01 00:09:00    21
Freq: 3T, dtype: int64
</code></pre>
<p>1.2實戰</p>
<p>獲取日K真實的數據：</p>
<pre><code class="language-python">#獲取日k
df = get_price(&quot;000001.XSHG&quot;, end_date='2021-05-30 14:00:00',count=20, frequency='1d', fields=['open','close','high','low','volume','money'])  
print(df)
</code></pre>
<p>可以看到獲取到瞭<code>4月28號</code>到<code>5月28號</code>的所有數據。為瞭更方便理解 我們再添加一列數據，就是當前日期是<code>星期幾</code>的列。</p>
<pre><code class="language-python">#獲取日k
df = get_price(&quot;000001.XSHG&quot;, end_date='2021-05-30 14:00:00',count=20, frequency='1d', fields=['open','close','high','low','volume','money'])  
df['weekday']=df.index.weekday
print(df)
</code></pre>
<p>這裡<code>0</code>代表週一，這裡如何轉換為按“<strong>周</strong>”統計呢</p>
<pre><code class="language-python">#獲取周k
import pandas as pd
df_week = pd.DataFrame()
df_week = df['open'].resample('W').first()
print(df_week)
</code></pre>
<p>可以看到這裡的<code>2021-05-30</code>是一個禮拜的最後一天。它對應的開盤價確實是這個數字。說明我們計算的周K數據是正確的。</p>
<p><strong>收盤價</strong>就是<code>每週收盤價</code>最後一天的數據。</p>
<p><strong>最高價</strong>就是<code>每週收盤價</code>的最大值。</p>
<p><strong>最低價</strong>就是<code>每週收盤價</code>的最小值。</p>
<pre><code class="language-python">#獲取周k
import pandas as pd
df_week = pd.DataFrame()
df_week['open'] = df['open'].resample('W').first()
df_week['close'] = df['close'].resample('W').last()
df_week['high'] = df['high'].resample('W').max()
df_week['low'] = df['low'].resample('W').min()
print(df_week)
</code></pre>
<p>對比數據，close是最後一天的收盤價的數據。high是當前周的每天的最高價的最高價。low是當前周的每天的最低價的最低價。</p>
<p>我們通過不到10行代碼就能將<code>日K</code>的數據轉換為<code>周K</code>的數據。</p>
<h3 id="2匯總統計功能統計月成交量成交額"><a class="header" href="#2匯總統計功能統計月成交量成交額">2.匯總統計功能（統計月成交量、成交額）</a></h3>
<p>匯總成交量和成交額</p>
<p>我想要把<code>volume</code>(成交量)和<code>money</code>(成交額)轉換為<strong>總成交量</strong>和<strong>總成交額</strong></p>
<pre><code class="language-python">#獲取周k
import pandas as pd
df_week = pd.DataFrame()
df_week['open'] = df['open'].resample('W').first()
df_week['close'] = df['close'].resample('W').last()
df_week['high'] = df['high'].resample('W').max()
df_week['low'] = df['low'].resample('W').min()
df_week['volume(sum)'] = df['volume'].resample('W').sum()
df_week['money(sum)'] = df['money'].resample('W').sum()
print(df_week)
</code></pre>
<h3 id="3日k-轉換為-月k"><a class="header" href="#3日k-轉換為-月k">3.日K 轉換為 月K</a></h3>
<p>假設我有一年的數據，如果想轉換為月K應該怎麼轉？</p>
<p>隻需要改2個地方：</p>
<ul>
<li>添加<code>start_date</code>獲取到一整年的數據</li>
<li>將<code>resample</code>的參數改為M即可，M代表Month</li>
</ul>
<pre><code class="language-python">#獲取日k
df = get_price(&quot;000001.XSHG&quot;, end_date='2021-05-30 14:00:00', start_date='2020-05-30', frequency='1d', fields=['open','close','high','low','volume','money'])  
df['weekday']=df.index.weekday
print(df)

#獲取周k
import pandas as pd
df_week = pd.DataFrame()
df_week['open'] = df['open'].resample('M').first()
df_week['close'] = df['close'].resample('M').last()
df_week['high'] = df['high'].resample('M').max()
df_week['low'] = df['low'].resample('M').min()
print(df_week)
</code></pre>
<p>以上就是Python量化交易實戰之使用Resample函數轉換“日K”數據的詳細內容，更多關於Python Resample函數轉換“日K”數據的資料請關註WalkonNet其它相關文章！</p>
<h3 id="推薦閱讀"><a class="header" href="#推薦閱讀">推薦閱讀：</a></h3>
<ul>
<li><a href="https://walkonnet.com/archives/459801">Python Pandas高級教程之時間處理</a></li>
<li><a href="https://walkonnet.com/archives/543015">python數學建模之三大模型與十大常用算法詳情</a></li>
<li><a href="https://walkonnet.com/archives/541137">Python Pandas 中的數據結構詳解</a></li>
<li><a href="https://walkonnet.com/archives/540162">python Pandas時序數據處理</a></li>
<li><a href="https://walkonnet.com/archives/541225">Python pandas索引的設置和修改方法</a></li>
</ul>
<hr />
<h1 id="pandas-shift-sum"><a class="header" href="#pandas-shift-sum">pandas shift sum</a></h1>
<pre><code class="language-py">import pandas as pd
import numpy

df = pd.DataFrame(numpy.random.randint(0, 10, (10, 2)), columns=['a','b'])
df['c'] = df.b.rolling(window = 3).sum().shift()
print(df)
</code></pre>
<pre><code class="language-py">import pandas as pd

df = pd.DataFrame(
    {
        &quot;Name&quot;: [
            &quot;A&quot;,
            &quot;B&quot;,
            &quot;C&quot;,
            &quot;D&quot;,
            &quot;E&quot;,
            &quot;F&quot;,
            &quot;G&quot;,
            &quot;H&quot;,
            &quot;I&quot;,
            &quot;J&quot;,
            &quot;K&quot;,
            &quot;L&quot;,
            &quot;M&quot;,
            &quot;N&quot;,
            &quot;O&quot;,
        ],
        &quot;Sex&quot;: [
            &quot;M&quot;,
            &quot;M&quot;,
            &quot;M&quot;,
            &quot;F&quot;,
            &quot;F&quot;,
            &quot;M&quot;,
            &quot;F&quot;,
            &quot;M&quot;,
            &quot;F&quot;,
            &quot;M&quot;,
            &quot;M&quot;,
            &quot;M&quot;,
            &quot;F&quot;,
            &quot;M&quot;,
            &quot;M&quot;,
        ],
        &quot;Age&quot;: [38, 28, 31, 34, 28, 28, 36, 33, 22, 39, 22, 24, 31, 29, 22],
        &quot;Height&quot;: [
            1.74,
            1.51,
            1.67,
            1.87,
            1.8,
            1.51,
            1.85,
            1.89,
            1.81,
            1.72,
            1.75,
            1.64,
            1.9,
            1.62,
            1.61,
        ],
        &quot;Weight&quot;: [45, 63, 39, 45, 67, 66, 53, 45, 72, 46, 58, 44, 73, 70, 51],
    }
)

df_eg1 = df.copy()
# 第 1 個用法
def BMI_1(r):
    return round(r[&quot;Weight&quot;] / (r[&quot;Height&quot;] ** 2), ndigits=2)


df_eg1[&quot;BMI_apply1&quot;] = df_eg1.apply(BMI_1, axis=1)
# 第 2 個用法
def BMI_2(weight, height):
    return round(weight / (height ** 2), ndigits=2)


df_eg1[&quot;BMI_apply2&quot;] = df_eg1.apply(lambda r: BMI_2(r[&quot;Weight&quot;], r[&quot;Height&quot;]), axis=1)
print(df_eg1)
</code></pre>
<pre><code class="language-py">import pandas as pd

def sum(x, y, z, m, df):
    for index, row in df.iterrows():
        print(row)
    return (x + y + z) * m


df = pd.DataFrame({'A': [1, 2], 'B': [10, 20]})
df1 = df.apply(sum, args=(1, 2), m=10, df=df)
print(df1)

</code></pre>
<pre><code class="language-py">import pandas as pd


def apply_func(tsC, tsD):
    return tsC.mean() + tsD.mean()


dates = pd.date_range(&quot;20130101&quot;, periods=13, freq=&quot;D&quot;)
df = pd.DataFrame(
    {
        &quot;C&quot;: [1, 9, 2, 4, 5, -1, 6, 9, 3, 5, 10, -3, -5],
        &quot;D&quot;: [3, 8, 2, 6, 9, 1, 26, 89, 4, 2, 1, -13, 75],
    },
    index=dates,
)
df.index.name = &quot;datetime&quot;
print(df)

df[&quot;rmean&quot;] = (
    df[&quot;C&quot;]
    .rolling(window=3)
    .apply(lambda x: apply_func(df.loc[x.index, &quot;C&quot;], df.loc[x.index, &quot;D&quot;]))
)

print(df)
</code></pre>
<pre><code class="language-py">stringList = [&quot;252.007&quot;, &quot;546.658&quot;, &quot;252.108&quot;]
paramValue = [&quot;252.017&quot;, &quot;546.658&quot;, &quot;252.008&quot;]

def compareList(l1, l2):
    return [i&gt;j for i, j in zip(l1, l2)]

print(compareList(stringList, paramValue)) 
</code></pre>
<pre><code class="language-py">import pandas as pd
import numpy


def test(data):
    return sum(data)


df = pd.DataFrame(numpy.random.randint(0, 10, (10, 2)), columns=[&quot;a&quot;, &quot;b&quot;])
# print(df)
c = df.b.rolling(window=3).apply(test).shift()
# df['c'] = df.b.rolling(window = 3).sum().shift(1)
# df['d'] = df.b.rolling(window = 3).sum().shift(2)
print(df, &quot;\n&quot;, c)
</code></pre>
<pre><code class="language-py">from numpy_ext import rolling_apply
import pandas as pd
import numpy


def test(a, b):
    return sum(a) + sum(b)


df = pd.DataFrame(numpy.random.randint(0, 10, (10, 2)), columns=[&quot;a&quot;, &quot;b&quot;])
df[&quot;c&quot;] = rolling_apply(test, 3, df.a.values, df.b.values)
df[&quot;c&quot;] = df[&quot;c&quot;].shift()
print(df, type(df[&quot;c&quot;]))
</code></pre>
<h3 id="resample"><a class="header" href="#resample">Resample</a></h3>
<pre><code class="language-python"># https://medium.com/uxai/%E9%87%8F%E5%8C%96%E6%8A%95%E8%B3%87-ai-for-trading-1-%E7%8D%B2%E5%8F%96%E5%B8%82%E5%A0%B4%E8%B3%87%E6%96%99-109791cde0f5
import yfinance as yf
import pandas as pd


def get_info_on_stock(ticker):
    stock = yf.Ticker(ticker)
    # 拿上市至今的收盤價
    hist_all = stock.history(period=&quot;max&quot;)[&quot;Close&quot;]
    # 拿近 30 天的所有資料
    hist_30 = stock.history(period=&quot;30d&quot;)
    return hist_all


def get_info_on_stocks(track_list):
    df = pd.DataFrame()
    for stock in track_list:
        stock_info = yf.Ticker(stock)
        # 拿近 10 天的資料
        hist = stock_info.history(period=&quot;360d&quot;)
        # 做一些簡單的處理後把 dataframe 接起來
        hist[&quot;Stock_id&quot;] = stock
        hist[&quot;Date&quot;] = hist.index
        hist = hist[
            [
                &quot;Date&quot;,
                &quot;Stock_id&quot;,
                &quot;Open&quot;,
                &quot;High&quot;,
                &quot;Low&quot;,
                &quot;Close&quot;,
                &quot;Volume&quot;,
                &quot;Dividends&quot;,
                &quot;Stock Splits&quot;,
            ]
        ]
        df = pd.concat([df, hist])
    return df.set_index([pd.Index([i for i in range(len(df))])]).round(1)


if __name__ == &quot;__main__&quot;:
    data = get_info_on_stock(&quot;2330.TW&quot;)
    print(data)

    # 選定我們要比較的公司
    track_list = [&quot;2330.TW&quot;, &quot;2303.TW&quot;]
    df = get_info_on_stocks(track_list)
    print(df, type(df))

    # 接下來我們可以做一些簡單的計算，利用 pandas 內建的函數來看兩者資訊的平均 (mean):
    df_mean = df.groupby(&quot;Stock_id&quot;).mean()
    print(df_mean)

    # 前面的圖可以看到我們是將同一個時間的兩個公司資訊堆疊起來，接下來我們可以試著用另一種表示方式來做比較：
    open_prices = df.pivot(index=&quot;Date&quot;, columns=&quot;Stock_id&quot;, values=&quot;Open&quot;)
    high_prices = df.pivot(index=&quot;Date&quot;, columns=&quot;Stock_id&quot;, values=&quot;High&quot;)
    low_prices = df.pivot(index=&quot;Date&quot;, columns=&quot;Stock_id&quot;, values=&quot;Low&quot;)
    close_prices = df.pivot(index=&quot;Date&quot;, columns=&quot;Stock_id&quot;, values=&quot;Close&quot;)
    volume = df.pivot(index=&quot;Date&quot;, columns=&quot;Stock_id&quot;, values=&quot;Volume&quot;)
    print(close_prices.mean())
    print(close_prices)
    # print(close_prices['2303.TW'])
    df_month_open = open_prices.resample(&quot;M&quot;).first()
    df_month_high = high_prices.resample(&quot;M&quot;).max()
    df_month_low = low_prices.resample(&quot;M&quot;).min()
    df_month_close = close_prices.resample(&quot;M&quot;).last()
    print(df_month_open)
</code></pre>
<pre><code class="language-python">from finlab import data
import datetime
import numpy as np
import pandas as pd
import finlab
import functools


class MyFinlabDataFrame(pd.DataFrame):
    &quot;&quot;&quot;回測語法糖
    除了使用熟悉的 Pandas 語法外，我們也提供很多語法糖，讓大家開發程式時，可以用簡易的語法完成複雜的功能，讓開發策略更簡潔！
    我們將所有的語法糖包裹在 `MyFinlabDataFrame` 中，用起來跟 `pd.DataFrame` 一樣，但是多了很多功能！
    只要使用 `finlab.data.get()` 所獲得的資料，皆為 `MyFinlabDataFrame` 格式，
    接下來我們就來看看， `MyFinlabDataFrame` 有哪些好用的語法糖吧！

    當資料日期沒有對齊（例如: 財報 vs 收盤價 vs 月報）時，在使用以下運算符號：`+`, `-`, `*`, `/`, `&gt;`, `&gt;=`, `==`, `&lt;`, `&lt;=`, `&amp;`, `|`, `~`，不需要先將資料對齊，因為 `MyFinlabDataFrame` 會自動幫你處理，以下是示意圖。

    &lt;img src=&quot;https://i.ibb.co/pQr5yx5/Screen-Shot-2021-10-26-at-5-32-44-AM.png&quot; alt=&quot;Screen-Shot-2021-10-26-at-5-32-44-AM&quot;&gt;

    以下是範例：`cond1` 與 `cond2` 分別為「每天」，和「每季」的資料，假如要取交集的時間，可以用以下語法：

    ```py
    from finlab import data
    # 取得 MyFinlabDataFrame
    close = data.get('price:收盤價')
    roa = data.get('fundamental_features:ROA稅後息前')

    # 運算兩個選股條件交集
    cond1 = close &gt; 37
    cond2 = roa &gt; 0
    cond_1_2 = cond1 &amp; cond2

    擷取 1101 臺泥 的訊號如下圖，可以看到 `cond1` 跟 `cond2` 訊號的頻率雖然不相同，但是由於 `cond1` 跟 `cond2` 是 `MyFinlabDataFrame`，所以可以直接取交集，而不用處理資料頻率對齊的問題。
    &lt;br /&gt;
    &lt;img src=&quot;https://i.ibb.co/m9chXSQ/imageconds.png&quot; alt=&quot;imageconds&quot;&gt;
    
    總結來說，MyFinlabDataFrame 與一般 dataframe 唯二不同之處：
    1. 多了一些 method，如`df.is_largest()`, `df.sustain()`...等。
    2. 在做四則運算、不等式運算前，會將 df1、df2 的 index 取聯集，column 取交集。
    &quot;&quot;&quot;
    
    @property
    def _constructor(self):
        return MyFinlabDataFrame
    
    @staticmethod
    def reshape(df1, df2):
    
        isfdf1 = isinstance(df1, MyFinlabDataFrame)
        isfdf2 = isinstance(df2, MyFinlabDataFrame)
        isdf1 = isinstance(df1, pd.DataFrame)
        isdf2 = isinstance(df2, pd.DataFrame)
    
        both_are_dataframe = (isfdf1 + isdf1) * (isfdf2 + isdf2) != 0
    
        d1_index_freq = df1.get_index_str_frequency() if isfdf1 else None
        d2_index_freq = df2.get_index_str_frequency() if isfdf2 else None
    
        if (
            (d1_index_freq or d2_index_freq)
            and (d1_index_freq != d2_index_freq)
            and both_are_dataframe
        ):
    
            df1 = df1.index_str_to_date() if isfdf1 else df1
            df2 = df2.index_str_to_date() if isfdf2 else df2
    
        if isinstance(df2, pd.Series):
            df2 = pd.DataFrame({c: df2 for c in df1.columns})
    
        if both_are_dataframe:
            index = df1.index.union(df2.index)
            columns = df1.columns.intersection(df2.columns)
    
            if len(df1.index) * len(df2.index) != 0:
                index_start = max(df1.index[0], df2.index[0])
                index = [t for t in index if index_start &lt;= t]
    
            return (
                df1.reindex(index=index, method=&quot;ffill&quot;)[columns],
                df2.reindex(index=index, method=&quot;ffill&quot;)[columns],
            )
        else:
            return df1, df2
    
    def __lt__(self, other):
        df1, df2 = self.reshape(self, other)
        return pd.DataFrame.__lt__(df1, df2)
    
    def __gt__(self, other):
        df1, df2 = self.reshape(self, other)
        return pd.DataFrame.__gt__(df1, df2)
    
    def __le__(self, other):
        df1, df2 = self.reshape(self, other)
        return pd.DataFrame.__le__(df1, df2)
    
    def __ge__(self, other):
        df1, df2 = self.reshape(self, other)
        return pd.DataFrame.__ge__(df1, df2)
    
    def __eq__(self, other):
        df1, df2 = self.reshape(self, other)
        return pd.DataFrame.__eq__(df1, df2)
    
    def __ne__(self, other):
        df1, df2 = self.reshape(self, other)
        return pd.DataFrame.__ne__(df1, df2)
    
    def __sub__(self, other):
        df1, df2 = self.reshape(self, other)
        return pd.DataFrame.__sub__(df1, df2)
    
    def __add__(self, other):
        df1, df2 = self.reshape(self, other)
        return pd.DataFrame.__add__(df1, df2)
    
    def __mul__(self, other):
        df1, df2 = self.reshape(self, other)
        return pd.DataFrame.__mul__(df1, df2)
    
    def __truediv__(self, other):
        df1, df2 = self.reshape(self, other)
        return pd.DataFrame.__truediv__(df1, df2)
    
    def __rshift__(self, other):
        return self.shift(-other)
    
    def __lshift__(self, other):
        return self.shift(other)
    
    def __and__(self, other):
        df1, df2 = self.reshape(self, other)
        return pd.DataFrame.__and__(df1, df2)
    
    def __or__(self, other):
        df1, df2 = self.reshape(self, other)
        return pd.DataFrame.__or__(df1, df2)
    
    def __getitem__(self, other):
        df1, df2 = self.reshape(self, other)
        return pd.DataFrame.__getitem__(df1, df2)
    
    def index_str_to_date(self):
        &quot;&quot;&quot;財務月季報索引格式轉換
    
        將以下資料的索引轉換成datetime格式:
    
        月營收 (ex:2022-M1) 從文字格式轉為公告截止日。
    
        財務季報 (ex:2022-Q1) 從文字格式轉為財報電子檔資料上傳日。
    
        通常使用情境為對不同週期的dataframe做reindex，常用於以公告截止日作為訊號產生日。
    
        Returns:
          (pd.DataFrame): data
        Examples:
    
            ```py
            data.get('monthly_revenue:當月營收').index_str_to_date()
            data.get('financial_statement:現金及約當現金').index_str_to_date()
</code></pre>
<pre><code>  &quot;&quot;&quot;
    if len(self.index) == 0 or not isinstance(self.index[0], str):
        return self

    if self.index[0].find(&quot;M&quot;) != -1:
        return self._index_str_to_date_month()
    elif self.index[0].find(&quot;Q&quot;) != -1:
        return self._index_str_to_date_season()

    return self

@staticmethod
def to_business_day(date):
    def skip_weekend(d):
        add_days = {5: 2, 6: 1}
        wd = d.weekday()
        if wd in add_days:
            d += datetime.timedelta(days=add_days[wd])
        return d

    close = data.get(&quot;price:收盤價&quot;)
    return (
        pd.Series(date)
        .apply(
            lambda d: skip_weekend(d)
            if d in close.index or d &lt; close.index[0] or d &gt; close.index[-1]
            else close.loc[d:].index[0]
        )
        .values
    )

def get_index_str_frequency(self):

    if len(self.index) == 0:
        return None

    if not isinstance(self.index[0], str):
        return None

    if (self.index.str.find(&quot;M&quot;) != -1).all():
        return &quot;month&quot;

    if (self.index.str.find(&quot;Q&quot;) != -1).all():
        return &quot;season&quot;

    return None

def _index_date_to_str_month(self):

    # index is already str
    if len(self.index) == 0 or not isinstance(self.index[0], pd.Timestamp):
        return self

    index = (self.index - datetime.timedelta(days=30)).strftime(&quot;%Y-M%m&quot;)
    return MyFinlabDataFrame(self.values, index=index, columns=self.columns)

def _index_str_to_date_month(self):

    # index is already timestamps
    if len(self.index) == 0 or not isinstance(self.index[0], str):
        return self

    if not (self.index.str.find(&quot;M&quot;) != -1).all():
        logger.warning(
            &quot;MyFinlabDataFrame: invalid index, cannot format index to monthly timestamp.&quot;
        )
        return self

    index = (
        pd.to_datetime(self.index, format=&quot;%Y-M%m&quot;)
        + pd.offsets.MonthBegin()
        + datetime.timedelta(days=9)
    )
    # chinese new year and covid-19 impact monthly revenue deadline
    replacements = {
        datetime.datetime(2020, 2, 10): datetime.datetime(2020, 2, 15),
        datetime.datetime(2021, 2, 10): datetime.datetime(2021, 2, 15),
        datetime.datetime(2022, 2, 10): datetime.datetime(2022, 2, 14),
    }
    replacer = replacements.get
    index = [replacer(n, n) for n in index]

    index = self.to_business_day(index)

    ret = MyFinlabDataFrame(self.values, index=index, columns=self.columns)
    ret.index.name = &quot;date&quot;

    return ret

def _index_date_to_str_season(self):

    # index is already str
    if len(self.index) == 0 or not isinstance(self.index[0], pd.Timestamp):
        return self

    q = (
        self.index.strftime(&quot;%m&quot;)
        .astype(int)
        .map({5: 1, 8: 2, 9: 2, 10: 3, 11: 3, 3: 4, 4: 4})
    )
    year = self.index.year.copy()
    year -= q == 4
    index = year.astype(str) + &quot;-Q&quot; + q.astype(str)

    return MyFinlabDataFrame(self.values, index=index, columns=self.columns)

def deadline(self):
    &quot;&quot;&quot;財務季報索引轉換成公告截止日

      將財務季報 (ex:2022Q1) 從文字格式轉為公告截止日的datetime格式，
      通常使用情境為對不同週期的dataframe做reindex，常用於以公告截止日作為訊號產生日。
      Returns:
        (pd.DataFrame): data
      Examples:
          ```py
          data.get('financial_statement:現金及約當現金').deadline()
          ```
    &quot;&quot;&quot;
    return self._index_str_to_date_season(detail=False)

def _index_str_to_date_season(self, detail=True):

    disclosure_dates = calc_disclosure_dates(detail).reindex_like(self).unstack()

    self.columns.name = &quot;stock_id&quot;

    unstacked = self.unstack()

    ret = (
        pd.DataFrame(
            {&quot;value&quot;: unstacked.values, &quot;disclosures&quot;: disclosure_dates.values,},
            unstacked.index,
        )
        .reset_index()
        .drop_duplicates([&quot;disclosures&quot;, &quot;stock_id&quot;])
        .pivot(index=&quot;disclosures&quot;, columns=&quot;stock_id&quot;, values=&quot;value&quot;)
        .ffill()
        .pipe(lambda df: df.loc[df.index.notna()])
        .pipe(lambda df: MyFinlabDataFrame(df))
        .rename_axis(&quot;date&quot;)
    )

    if not detail:
        ret.index = self.to_business_day(ret.index)

    return ret

def average(self, n):
    &quot;&quot;&quot;取 n 筆移動平均

    若股票在時間窗格內，有 N/2 筆 NaN，則會產生 NaN。
    Args:
      n (positive-int): 設定移動窗格數。
    Returns:
      (pd.DataFrame): data
    Examples:
        股價在均線之上
        ```py
        from finlab import data
        close = data.get('price:收盤價')
        sma = close.average(10)
        cond = close &gt; sma
        ```
        只需要簡單的語法，就可以將其中一部分的訊號繪製出來檢查：
        ```py
        import matplotlib.pyplot as plt

        close.loc['2021', '2330'].plot()
        sma.loc['2021', '2330'].plot()
        cond.loc['2021', '2330'].mul(20).add(500).plot()

        plt.legend(['close', 'sma', 'cond'])
        ```
        &lt;img src=&quot;https://i.ibb.co/Mg1P85y/sma.png&quot; alt=&quot;sma&quot;&gt;
    &quot;&quot;&quot;
    return self.rolling(n, min_periods=int(n / 2)).mean()

def is_largest(self, n):
    &quot;&quot;&quot;取每列前 n 筆大的數值

    若符合 `True` ，反之為 `False` 。用來篩選每天數值最大的股票。

    &lt;img src=&quot;https://i.ibb.co/8rh3tbt/is-largest.png&quot; alt=&quot;is-largest&quot;&gt;
    Args:
      n (positive-int): 設定每列前 n 筆大的數值。
    Returns:
      (pd.DataFrame): data
    Examples:
        每季 ROA 前 10 名的股票
        ```py
        from finlab import data

        roa = data.get('fundamental_features:ROA稅後息前')
        good_stocks = roa.is_largest(10)
        ```
    &quot;&quot;&quot;
    return (
        self.astype(float)
        .apply(lambda s: s.nlargest(n), axis=1)
        .reindex_like(self)
        .notna()
    )

def is_smallest(self, n):
    &quot;&quot;&quot;取每列前 n 筆小的數值

    若符合 `True` ，反之為 `False` 。用來篩選每天數值最小的股票。
    Args:
      n (positive-int): 設定每列前 n 筆小的數值。
    Returns:
      (pd.DataFrame): data
    Examples:
        股價淨值比最小的 10 檔股票
        ```py
        from finlab import data

        pb = data.get('price_earning_ratio:股價淨值比')
        cheap_stocks = pb.is_smallest(10)
        ```
    &quot;&quot;&quot;
    return (
        self.astype(float)
        .apply(lambda s: s.nsmallest(n), axis=1)
        .reindex_like(self)
        .notna()
    )

def is_entry(self):
    &quot;&quot;&quot;進場點

    取進場訊號點，若符合條件的值則為True，反之為False。
    Returns:
      (pd.DataFrame): data
    Examples:
      策略為每日收盤價前10高，取進場點。
        ```py
        from finlab import data
        data.get('price:收盤價').is_largest(10).is_entry()
        ```
    &quot;&quot;&quot;
    return self &amp; ~self.shift(fill_value=False)

def is_exit(self):
    &quot;&quot;&quot;出場點

    取出場訊號點，若符合條件的值則為 True，反之為 False。
    Returns:
      (pd.DataFrame): data
    Examples:
      策略為每日收盤價前10高，取出場點。
        ```py
        from finlab import data
        data.get('price:收盤價').is_largest(10).is_exit()
        ```
    &quot;&quot;&quot;
    return ~self &amp; self.shift(fill_value=False)

def rise(self, n=1):
    &quot;&quot;&quot;數值上升中

    取是否比前第n筆高，若符合條件的值則為True，反之為False。
    &lt;img src=&quot;https://i.ibb.co/Y72bN5v/Screen-Shot-2021-10-26-at-6-43-41-AM.png&quot; alt=&quot;Screen-Shot-2021-10-26-at-6-43-41-AM&quot;&gt;
    Args:
      n (positive-int): 設定比較前第n筆高。
    Returns:
      (pd.DataFrame): data
    Examples:
        收盤價是否高於10日前股價
        ```py
        from finlab import data
        data.get('price:收盤價').rise(10)
        ```
    &quot;&quot;&quot;
    return self &gt; self.shift(n)

def fall(self, n=1):
    &quot;&quot;&quot;數值下降中

    取是否比前第n筆低，若符合條件的值則為True，反之為False。
    &lt;img src=&quot;https://i.ibb.co/Y72bN5v/Screen-Shot-2021-10-26-at-6-43-41-AM.png&quot; alt=&quot;Screen-Shot-2021-10-26-at-6-43-41-AM&quot;&gt;
    Args:
      n (positive-int): 設定比較前第n筆低。
    Returns:
      (pd.DataFrame): data
    Examples:
        收盤價是否低於10日前股價
        ```py
        from finlab import data
        data.get('price:收盤價').fall(10)
        ```
    &quot;&quot;&quot;
    return self &lt; self.shift(n)

def groupby_category(self):
    &quot;&quot;&quot;資料按產業分群

    類似 `pd.DataFrame.groupby()`的處理效果。
    Returns:
      (pd.DataFrame): data
    Examples:
      半導體平均股價淨值比時間序列
        ```py
        from finlab import data
        pe = data.get('price_earning_ratio:股價淨值比')
        pe.groupby_category().mean()['半導體'].plot()
        ```
        &lt;img src=&quot;https://i.ibb.co/Tq2fKBp/pbmean.png&quot; alt=&quot;pbmean&quot;&gt;

        全球 2020 量化寬鬆加上晶片短缺，使得半導體股價淨值比衝高。
    &quot;&quot;&quot;
    categories = data.get(&quot;security_categories&quot;)
    cat = categories.set_index(&quot;stock_id&quot;).category.to_dict()
    org_set = set(cat.values())
    set_remove_illegal = set(
        o for o in org_set if isinstance(o, str) and o != &quot;nan&quot;
    )
    set_remove_illegal

    refine_cat = {}
    for s, c in cat.items():
        if c == None or c == &quot;nan&quot;:
            refine_cat[s] = &quot;其他&quot;
            continue

        if c == &quot;電腦及週邊&quot;:
            refine_cat[s] = &quot;電腦及週邊設備業&quot;
            continue

        if c[-1] == &quot;業&quot; and c[:-1] in set_remove_illegal:
            refine_cat[s] = c[:-1]
        else:
            refine_cat[s] = c

    col_categories = pd.Series(
        self.columns.map(lambda s: refine_cat[s] if s in cat else &quot;其他&quot;)
    )

    return self.groupby(col_categories.values, axis=1)

def entry_price(self, trade_at=&quot;close&quot;):

    signal = self.is_entry()
    adj = (
        data.get(&quot;etl:adj_close&quot;)
        if trade_at == &quot;close&quot;
        else data.get(&quot;etl:adj_open&quot;)
    )
    adj, signal = adj.reshape(adj.loc[signal.index[0] : signal.index[-1]], signal)
    return adj.bfill()[signal.shift(fill_value=False)].ffill()

def sustain(self, nwindow, nsatisfy=None):
    &quot;&quot;&quot;持續 N 天滿足條件

    取移動 nwindow 筆加總大於等於nsatisfy，若符合條件的值則為True，反之為False。

    Args:
      nwindow (positive-int): 設定移動窗格。
      nsatisfy (positive-int): 設定移動窗格計算後最低滿足數值。
    Returns:
      (pd.DataFrame): data
    Examples:
        收盤價是否連兩日上漲
        ```py
        from finlab import data
        data.get('price:收盤價').rise().sustain(2)
        ```
    &quot;&quot;&quot;
    nsatisfy = nsatisfy or nwindow
    return self.rolling(nwindow).sum() &gt;= nsatisfy

def industry_rank(self, categories=None):
    &quot;&quot;&quot;計算產業 ranking 排名，0 代表產業內最低，1 代表產業內最高
    Args:
      categories (list of str): 欲考慮的產業，ex: ['貿易百貨', '雲端運算']，預設為全產業，請參考 `data.get('security_industry_themes')` 中的產業項目。
    Examples:
        本意比產業排名分數
        ```py
        from finlab import data

        pe = data.get('price_earning_ratio:本益比')
        pe_rank = pe.industry_rank()
        print(pe_rank)
        ```
    &quot;&quot;&quot;

    themes = (
        data.get(&quot;security_industry_themes&quot;)
        .copy()  # 複製
        .assign(
            category=lambda self: self.category.apply(lambda s: eval(s))
        )  # 從文字格式轉成陣列格
        .explode(&quot;category&quot;)  # 展開資料
    )

    categories = categories or set(
        themes.category[themes.category.str.find(&quot;:&quot;) == -1]
    )

    def calc_rank(ind):
        stock_ids = themes.stock_id[themes.category == ind]
        return self[stock_ids].pipe(lambda self: self.rank(axis=1, pct=True))

    return (
        pd.concat([calc_rank(ind) for ind in categories], axis=1)
        .groupby(level=0, axis=1)
        .mean()
    )

def quantile_row(self, c):
    &quot;&quot;&quot;股票當天數值分位數

    取得每列c定分位數的值。
    Args:
      c (positive-int): 設定每列 n 定分位數的值。
    Returns:
      (pd.DataFrame): data
    Examples:
        取每日股價前90％分位數
        ```py
        from finlab import data
        data.get('price:收盤價').quantile_row(0.9)
        ```
    &quot;&quot;&quot;
    s = self.quantile(c, axis=1)
    return s

def exit_when(self, exit):

    df, exit = self.reshape(self, exit)

    df.fillna(False, inplace=True)
    exit.fillna(False, inplace=True)

    entry_signal = df.is_entry()
    exit_signal = df.is_exit()
    exit_signal |= exit

    # build position using entry_signal and exit_signal
    position = pd.DataFrame(np.nan, index=df.index, columns=df.columns)
    position[entry_signal] = 1
    position[exit_signal] = 0

    position.ffill(inplace=True)
    position = position == 1
    position.fillna(False)
    return position

def hold_until(
    self,
    exit,
    nstocks_limit=None,
    stop_loss=-np.inf,
    take_profit=np.inf,
    trade_at=&quot;close&quot;,
    rank=None,
):
    &quot;&quot;&quot;訊號進出場

    這大概是所有策略撰寫中，最重要的語法糖，上述語法中 `entries` 為進場訊號，而 `exits` 是出場訊號。所以 `entries.hold_until(exits)` ，就是進場訊號為 `True` 時，買入並持有該檔股票，直到出場訊號為 `True ` 則賣出。
    &lt;img src=&quot;https://i.ibb.co/PCt4hPd/Screen-Shot-2021-10-26-at-6-35-05-AM.png&quot; alt=&quot;Screen-Shot-2021-10-26-at-6-35-05-AM&quot;&gt;
    此函式有很多細部設定，可以讓你最多選擇 N 檔股票做輪動。另外，當超過 N 檔進場訊號發生，也可以按照客製化的排序，選擇優先選入的股票。最後，可以設定價格波動當輪動訊號，來增加出場的時機點。

    Args:
      exit (pd.Dataframe): 出場訊號。
      nstocks_limit (int)`: 輪動檔數上限，預設為None。
      stop_loss (float): 價格波動輪動訊號，預設為None，不生成輪動訊號。範例：0.1，代表成本價下跌 10% 時產生出場訊號。
      take_profit (float): 價格波動輪動訊號，預設為None，不生成輪動訊號。範例：0.1，代表成本價上漲 10% 時產生出場訊號。
      trade_at (str): 價格波動輪動訊號參考價，預設為'close'。可選 `close` 或 `open`。
      rank (pd.Dataframe): 當天進場訊號數量超過 nstocks_limit 時，以 rank 數值越大的股票優先進場。
    Returns:
      (pd.DataFrame): data
    Examples:
        價格 &gt; 20 日均線入場, 價格 &lt; 60 日均線出場，最多持有10檔，超過 10 個進場訊號，則以股價淨值比小的股票優先選入。

        ```python
        from finlab import data
        from finlab.backtest import sim

        close = data.get('price:收盤價')
        pb = data.get('price_earning_ratio:股價淨值比')

        sma20 = close.average(20)
        sma60 = close.average(60)

        entries = close &gt; sma20
        exits = close &lt; sma60

        ＃pb前10小的標的做輪動
        position = entries.hold_until(exits, nstocks_limit=10, rank=-pb)
        sim(position)
        ```
    &quot;&quot;&quot;
    if nstocks_limit is None:
        nstocks_limit = len(self.columns)

    union_index = self.index.union(exit.index)
    intersect_col = self.columns.intersection(exit.columns)

    if stop_loss != -np.inf or take_profit != np.inf:
        price = data.get(f&quot;etl:adj_{trade_at}&quot;)
        union_index = union_index.union(
            price.loc[union_index[0] : union_index[-1]].index
        )
        intersect_col = intersect_col.intersection(price.columns)
    else:
        price = pd.DataFrame()

    if rank is not None:
        union_index = union_index.union(rank.index)
        intersect_col = intersect_col.intersection(rank.columns)

    entry = (
        self.reindex(union_index, columns=intersect_col, method=&quot;ffill&quot;)
        .ffill()
        .fillna(False)
    )
    exit = (
        exit.reindex(union_index, columns=intersect_col, method=&quot;ffill&quot;)
        .ffill()
        .fillna(False)
    )

    if price is not None:
        price = price.reindex(union_index, columns=intersect_col, method=&quot;ffill&quot;)

    if rank is not None:
        rank = rank.reindex(union_index, columns=intersect_col, method=&quot;ffill&quot;)
    else:
        rank = pd.DataFrame(1, index=union_index, columns=intersect_col)

    max_rank = rank.max().max()
    min_rank = rank.min().min()
    rank = (rank - min_rank) / (max_rank - min_rank)
    rank.fillna(0, inplace=True)

    def rotate_stocks(
        ret,
        entry,
        exit,
        nstocks_limit,
        stop_loss=-np.inf,
        take_profit=np.inf,
        price=None,
        ranking=None,
    ):

        nstocks = 0

        ret[0][np.argsort(entry[0])[-nstocks_limit:]] = 1
        ret[0][exit[0] == 1] = 0
        ret[0][entry[0] == 0] = 0

        entry_price = np.empty(entry.shape[1])
        entry_price[:] = np.nan

        for i in range(1, entry.shape[0]):

            # regitser entry price
            if stop_loss != -np.inf or take_profit != np.inf:
                is_entry = (ret[i - 2] == 0) if i &gt; 1 else (ret[i - 1] == 1)

                is_waiting_for_entry = np.isnan(entry_price) &amp; (ret[i - 1] == 1)

                is_entry |= is_waiting_for_entry

                entry_price[is_entry == 1] = price[i][is_entry == 1]

                # check stop_loss and take_profit
                returns = price[i] / entry_price
                stop = (returns &gt; 1 + abs(take_profit)) | (
                    returns &lt; 1 - abs(stop_loss)
                )
                exit[i] |= stop

            # run signal
            rank = entry[i] * ranking[i] + ret[i - 1] * 3
            rank[exit[i] == 1] = -1
            rank[(entry[i] == 0) &amp; (ret[i - 1] == 0)] = -1

            ret[i][np.argsort(rank)[-nstocks_limit:]] = 1
            ret[i][rank == -1] = 0

        return ret

    ret = pd.DataFrame(0, index=entry.index, columns=entry.columns)
    ret = rotate_stocks(
        ret.values,
        entry.astype(int).values,
        exit.astype(int).values,
        nstocks_limit,
        stop_loss,
        take_profit,
        price=price.values,
        ranking=rank.values,
    )

    return pd.DataFrame(ret, index=entry.index, columns=entry.columns)
</code></pre>
<p>@functools.lru_cache
def calc_disclosure_dates(detail=True):</p>
<pre><code>cinfo = data.get(&quot;company_basic_info&quot;).copy()
cinfo[&quot;id&quot;] = cinfo.stock_id.str.split(&quot; &quot;).str[0]
cinfo = cinfo.set_index(&quot;id&quot;)
cinfo = cinfo[~cinfo.index.duplicated(keep=&quot;last&quot;)]

def calc_default_disclosure_dates(s):
    sid = s.name
    cat = cinfo.loc[sid].產業類別 if sid in cinfo.index else &quot;etf&quot;
    short_name = cinfo.loc[sid].公司簡稱 if sid in cinfo.index else &quot;etf&quot;

    if cat == &quot;金融業&quot;:
        calendar = {
            &quot;1&quot;: &quot;-05-15&quot;,
            &quot;2&quot;: &quot;-08-31&quot;,
            &quot;3&quot;: &quot;-11-14&quot;,
            &quot;4&quot;: &quot;-03-31&quot;,
        }
    elif cat == &quot;金融保險業&quot;:
        calendar = {
            &quot;1&quot;: &quot;-04-30&quot;,
            &quot;2&quot;: &quot;-08-31&quot;,
            &quot;3&quot;: &quot;-10-31&quot;,
            &quot;4&quot;: &quot;-03-31&quot;,
        }
    elif &quot;KY&quot; in short_name:
        calendar = {
            &quot;old&quot;: {&quot;1&quot;: &quot;-05-15&quot;, &quot;2&quot;: &quot;-08-14&quot;, &quot;3&quot;: &quot;-11-14&quot;, &quot;4&quot;: &quot;-03-31&quot;,},
            &quot;new&quot;: {&quot;1&quot;: &quot;-05-15&quot;, &quot;2&quot;: &quot;-08-31&quot;, &quot;3&quot;: &quot;-11-14&quot;, &quot;4&quot;: &quot;-03-31&quot;,},
        }
    else:
        calendar = {
            &quot;1&quot;: &quot;-05-15&quot;,
            &quot;2&quot;: &quot;-08-14&quot;,
            &quot;3&quot;: &quot;-11-14&quot;,
            &quot;4&quot;: &quot;-03-31&quot;,
        }
    get_year = (
        lambda year, season: str(year) if int(season) != 4 else str(int(year) + 1)
    )
    ky_policy_check = lambda year: &quot;new&quot; if year &gt;= &quot;2021&quot; else &quot;old&quot;
    return pd.to_datetime(
        s.index.map(
            lambda d: get_year(d[:4], d[-1])
            + calendar[ky_policy_check(d[:4])][d[-1]]
        )
        if &quot;KY&quot; in short_name
        else s.index.map(lambda d: get_year(d[:4], d[-1]) + calendar[d[-1]])
    )

def season_end(s):

    calendar = {
        &quot;1&quot;: &quot;-3-31&quot;,
        &quot;2&quot;: &quot;-6-30&quot;,
        &quot;3&quot;: &quot;-9-30&quot;,
        &quot;4&quot;: &quot;-12-31&quot;,
    }
    return pd.to_datetime(s.index.map(lambda d: d[:4] + calendar[d[-1]]))

disclosure_dates = data.get(&quot;financial_statements_upload_detail:upload_date&quot;)
disclosure_dates = disclosure_dates.apply(pd.to_datetime)

financial_season_end = disclosure_dates.apply(season_end)
default_disclosure_dates = disclosure_dates.apply(calc_default_disclosure_dates)

disclosure_dates[
    (disclosure_dates &gt; default_disclosure_dates)
    | (disclosure_dates &lt; financial_season_end)
] = pd.NaT
disclosure_dates[(disclosure_dates.diff() &lt;= datetime.timedelta(days=0))] = pd.NaT
disclosure_dates.loc[&quot;2019-Q1&quot;, &quot;3167&quot;] = pd.NaT
disclosure_dates.loc[&quot;2015-Q1&quot;, &quot;5536&quot;] = pd.NaT
disclosure_dates.loc[&quot;2018-Q1&quot;, &quot;5876&quot;] = pd.NaT

disclosure_dates = disclosure_dates.fillna(default_disclosure_dates)
disclosure_dates.columns.name = &quot;stock_id&quot;

if detail:
    return disclosure_dates
return default_disclosure_dates
</code></pre>
<p>if <strong>name</strong> == &quot;<strong>main</strong>&quot;:
# finlab.login(&quot;&quot;)
# close = data.get(&quot;price:收盤價&quot;)
# close = MyFinlabDataFrame(close)
# rev = data.get(&quot;monthly_revenue:當月營收&quot;)
# rev = MyFinlabDataFrame(rev)</p>
<pre><code>## 股價創年新高
# cond1 = close == close.rolling(250).max()

## 確認營收底部，近月營收脫離近年穀底(連續3月的&quot;單月營收近12月最小值/近月營收&quot; &lt; 0.8)
# cond4 = ((rev.rolling(12).min()) / (rev) &lt; 0.8).sustain(3)
# print(cond1)
# print(cond4)
# print(cond1 &amp; cond4)

df = MyFinlabDataFrame(
    np.random.randint(0, 100, size=(10, 5)), columns=list(&quot;BCDEH&quot;)
)
df1 = MyFinlabDataFrame(
    np.random.randint(0, 100, size=(5, 4)), columns=list(&quot;ABCD&quot;)
)
df = df &gt; 50
df1 = df1 &gt; 50
print(df)
print(df1)
print(df &amp; df1)
</code></pre>
<pre><code>

## pandas 找出重複的列
```python
import pandas as pd

# Example dataframes
df1 = pd.DataFrame({
    'date': ['2002-02-01', '2002-02-01', '2002-03-01', '2002-03-01', '2002-04-01'],
    'stock_id': [1101, 1101, 1101, 1101, 1101],
    'country': ['Taiwan', 'Taiwan', 'Taiwan', 'Taiwan', 'Taiwan'],
    'revenue': [2200067000, 2200067000, 1404336000, 1404336000, 2028782000],
    'revenue_month': [1, 1, 2, 2, 3],
    'revenue_year': [2002, 2002, 2002, 2002, 2002]
})

df2 = pd.DataFrame({
    'date': ['2023-02-01', '2023-03-01', '2023-03-01', '2023-04-01', '2023-04-01'],
    'stock_id': [1101, 1101, 1101, 1101, 1101],
    'country': ['Taiwan', 'Taiwan', 'Taiwan', 'Taiwan', 'Taiwan'],
    'revenue': [7325221000, 7306069000, 7306069000, 11730367000, 11730367000],
    'revenue_month': [1, 2, 2, 3, 3],
    'revenue_year': [2023, 2023, 2023, 2023, 2023]
})


print(df1, df2)
concatenated = pd.concat([df1, df2], ignore_index=True)
differences = concatenated.drop_duplicates(keep=False)
print(differences)
</code></pre>
<h2 id="兩組-dataframe-找出多餘-row-組成-dataframe"><a class="header" href="#兩組-dataframe-找出多餘-row-組成-dataframe">兩組 dataframe 找出多餘 row 組成 dataframe</a></h2>
<pre><code class="language-python">import pandas as pd

# create the DataFrame
import pandas as pd

df1 = pd.DataFrame({'A': [1, 2, 3], 'B': [1, 5, 6]})
df2 = pd.DataFrame({'A': [1, 2], 'B': [1, 5]})
df = df1 - df2
print(df1.to_markdown())
print(&quot;\n&quot;)
print(df2.to_markdown())


result = df1 - df2

indexs = []

for index, row in df.iterrows():
    if row.A != 0 or row.B != 0:
        indexs.append(index)
        

print(&quot;\n&quot;)
result_df = df1.loc[indexs]
print(result_df.to_markdown())
</code></pre>

                        <script src="https://utteranc.es/client.js"
                            repo="imxood/imxood.github.io"
                            issue-term="pathname"
                            theme="boxy-light"
                            crossorigin="anonymous"
                            async>
                        </script>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../python/Rust_bindings_for_Python.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../python/coroutine.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../python/Rust_bindings_for_Python.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../python/coroutine.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_line_numbers = true;
        </script>
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../theme/custom/mermaid.min.js"></script>
        <script type="text/javascript" src="../theme/custom/mermaid-init.js"></script>
    </body>
</html>
